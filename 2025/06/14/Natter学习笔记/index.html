<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon-package/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-package/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-package/favicon-16x16.png">
  <link rel="mask-icon" href="/assets/images/favicon-package/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/assets/images/favicon-package/site.webmanifest">
  <meta name="google-site-verification" content="qIz-Tg08U6gyN_53z89yii0ZmKx2avfsO-iyOWhsRx8">
  <meta name="msvalidate.01" content="096F3D01D2AA04148F10750CD4566535">
  <meta name="yandex-verification" content="43f790b7e38394a4">
  <meta name="baidu-site-verification" content="codeva-LMZoUaXjJl">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"loli.fj.cn","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.23.2","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"atom-one-light","dark":"atom-one-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"language":true},"bookmark":{"enable":true,"color":"#222","save":"manual"},"mediumzoom":true,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="å‰è¨€é€šè¿‡MikeWang000000&#x2F;Natterå®ç°å½“å‰ç½‘è·¯NATæ£€æµ‹">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€ç¬”è®°ã€‘Natterå­¦ä¹ ç¬”è®°">
<meta property="og:url" content="https://loli.fj.cn/2025/06/14/Natter%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="57uv6Z6g55qE5Y2a5a6i">
<meta property="og:description" content="å‰è¨€é€šè¿‡MikeWang000000&#x2F;Natterå®ç°å½“å‰ç½‘è·¯NATæ£€æµ‹">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-06-14T15:14:03.000Z">
<meta property="article:modified_time" content="2025-10-25T07:39:44.900Z">
<meta property="article:author" content="57uv6Z6g">
<meta property="article:tag" content="Github">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://loli.fj.cn/2025/06/14/Natter%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://loli.fj.cn/2025/06/14/Natter%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/","path":"2025/06/14/Natterå­¦ä¹ ç¬”è®°/","title":"ã€ç¬”è®°ã€‘Natterå­¦ä¹ ç¬”è®°"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ã€ç¬”è®°ã€‘Natterå­¦ä¹ ç¬”è®° | 57uv6Z6g55qE5Y2a5a6i</title>
  






  <script async defer data-website-id="981ed5a0-eea5-4426-a8a9-c16a789ccc3f" src="https://umami.loli.fj.cn/script.js" data-host-url="https://umami.loli.fj.cn/"></script>


  
  <script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script>
  <script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous" defer></script>
  <script src="/lib/pangu/dist/browser/pangu.umd.js" integrity="sha256-erngBMP3zzoIM6eqQ8dmrReh2vqCRgWmORroIfVoDlE=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script><script src="/js/pjax.js" defer></script>

  <script src="/lib/hexo-generator-searchdb/dist/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"/lib/mathjax/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="57uv6Z6g55qE5Y2a5a6i" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">57uv6Z6g55qE5Y2a5a6i</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">MS4wLjABAAAA5qMD8Gzdcgq7HXUOviKB59i0-ybJ59jJvNzyaPt5XOsVNqP6DU7WLcoAXvdxvYdpğŸ’—<br><font color="red">æœ¬ç«™æ‰€æœ‰æ–‡ç« ä»…ä½œæŠ€æœ¯ç ”ç©¶ï¼Œè¯·å‹¿éæ³•ç ´åï¼Œè¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ï¼Œåæœè‡ªè´Ÿ</font></p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>å‹é“¾</a></li><li class="menu-item menu-item-reward"><a href="/reward/" rel="section"><i class="fa fa-hand-holding-heart fa-fw"></i>èµåŠ©</a></li><li class="menu-item menu-item-command"><a href="/command/" rel="section"><i class="fa fa-book fa-fw"></i>æŒ‡ä»¤</a></li><li class="menu-item menu-item-contribute"><a href="/contribute/" rel="section"><i class="fa fa-chart-line fa-fw"></i>è´¡çŒ®</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>è®¢é˜…</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

<link rel="manifest" href="/assets/images/favicon-package/site.webmanifest">

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E9%A1%B9%E7%9B%AE"><span class="nav-number">2.</span> <span class="nav-text">ä¸‹è½½é¡¹ç›®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="nav-number">2.1.</span> <span class="nav-text">æºä»£ç </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NAT%E6%A3%80%E6%B5%8B"><span class="nav-number">3.</span> <span class="nav-text">NATæ£€æµ‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%88%90"><span class="nav-number">4.</span> <span class="nav-text">å®Œæˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-number">5.</span> <span class="nav-text">å‚è€ƒæ–‡çŒ®</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="57uv6Z6g"
      src="/assets/images/avatar.gif">
  <p class="site-author-name" itemprop="name">57uv6Z6g</p>
  <div class="site-description" itemprop="description">5o2V5o2J5LiA5Y+q54ix5oqY6IW+55qE57uv6Z6g</div>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:00-isomer-cabbies@icloud.com" title="E-Mail â†’ mailto:00-isomer-cabbies@icloud.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/LittleSweetCookie" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;LittleSweetCookie" rel="noopener me" target="_blank"><i class="fab fa-telegram fa-fw"></i>Telegram</a>
      </span>
  </div>

<div id="aplayer-app"></div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://loli.fj.cn/2025/06/14/Natter%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.gif">
      <meta itemprop="name" content="57uv6Z6g">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="57uv6Z6g55qE5Y2a5a6i">
      <meta itemprop="description" content="5o2V5o2J5LiA5Y+q54ix5oqY6IW+55qE57uv6Z6g">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="ã€ç¬”è®°ã€‘Natterå­¦ä¹ ç¬”è®° | 57uv6Z6g55qE5Y2a5a6i">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ã€ç¬”è®°ã€‘Natterå­¦ä¹ ç¬”è®°
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-06-14 23:14:03" itemprop="dateCreated datePublished" datetime="2025-06-14T23:14:03+08:00">2025-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-10-25 15:39:44" itemprop="dateModified" datetime="2025-10-25T15:39:44+08:00">2025-10-25</time>
    </span>

  
    <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é€šè¿‡<a href="/302.html?target=https://github.com/MikeWang000000/Natter">MikeWang000000&#x2F;Natter</a>å®ç°å½“å‰ç½‘è·¯NATæ£€æµ‹</p>
<span id="more"></span>

<h2 id="ä¸‹è½½é¡¹ç›®"><a href="#ä¸‹è½½é¡¹ç›®" class="headerlink" title="ä¸‹è½½é¡¹ç›®"></a>ä¸‹è½½é¡¹ç›®</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/MikeWang000000/Natter.git</span><br><span class="line">cd Natter</span><br></pre></td></tr></table></figure>

<h3 id="æºä»£ç "><a href="#æºä»£ç " class="headerlink" title="æºä»£ç "></a>æºä»£ç </h3><figure class="highlight python"><figcaption><span>natter.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Natter - https://github.com/MikeWang000000/Natter</span></span><br><span class="line"><span class="string">Copyright (C) 2023  MikeWang000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This program is free software: you can redistribute it and/or modify</span></span><br><span class="line"><span class="string">it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="string">the Free Software Foundation, either version 3 of the License, or</span></span><br><span class="line"><span class="string">(at your option) any later version.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="string">but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="string">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="string">GNU General Public License for more details.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="string">along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> errno</span><br><span class="line"><span class="keyword">import</span> atexit</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">__version__ = <span class="string">&quot;2.1.1&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Logger</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    DEBUG = <span class="number">0</span></span><br><span class="line">    INFO  = <span class="number">1</span></span><br><span class="line">    WARN  = <span class="number">2</span></span><br><span class="line">    ERROR = <span class="number">3</span></span><br><span class="line">    rep = &#123;DEBUG: <span class="string">&quot;D&quot;</span>, INFO: <span class="string">&quot;I&quot;</span>, WARN: <span class="string">&quot;W&quot;</span>, ERROR: <span class="string">&quot;E&quot;</span>&#125;</span><br><span class="line">    level = INFO</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;256color&quot;</span> <span class="keyword">in</span> os.environ.get(<span class="string">&quot;TERM&quot;</span>, <span class="string">&quot;&quot;</span>):</span><br><span class="line">        GREY = <span class="string">&quot;\033[90;20m&quot;</span></span><br><span class="line">        YELLOW_BOLD = <span class="string">&quot;\033[33;1m&quot;</span></span><br><span class="line">        RED_BOLD = <span class="string">&quot;\033[31;1m&quot;</span></span><br><span class="line">        RESET = <span class="string">&quot;\033[0m&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        GREY = YELLOW_BOLD = RED_BOLD = RESET = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_level</span>(<span class="params">level</span>):</span><br><span class="line">        Logger.level = level</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">text=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        <span class="keyword">if</span> Logger.level &lt;= Logger.DEBUG:</span><br><span class="line">            sys.stderr.write((Logger.GREY + <span class="string">&quot;%s [%s] %s\n&quot;</span> + Logger.RESET) % (</span><br><span class="line">                time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>), Logger.rep[Logger.DEBUG], text</span><br><span class="line">            ))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">info</span>(<span class="params">text=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        <span class="keyword">if</span> Logger.level &lt;= Logger.INFO:</span><br><span class="line">            sys.stderr.write((<span class="string">&quot;%s [%s] %s\n&quot;</span>) % (</span><br><span class="line">                time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>), Logger.rep[Logger.INFO], text</span><br><span class="line">            ))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">warning</span>(<span class="params">text=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        <span class="keyword">if</span> Logger.level &lt;= Logger.WARN:</span><br><span class="line">            sys.stderr.write((Logger.YELLOW_BOLD + <span class="string">&quot;%s [%s] %s\n&quot;</span> + Logger.RESET) % (</span><br><span class="line">                time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>), Logger.rep[Logger.WARN], text</span><br><span class="line">            ))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">error</span>(<span class="params">text=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        <span class="keyword">if</span> Logger.level &lt;= Logger.ERROR:</span><br><span class="line">            sys.stderr.write((Logger.RED_BOLD + <span class="string">&quot;%s [%s] %s\n&quot;</span> + Logger.RESET) % (</span><br><span class="line">                time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>), Logger.rep[Logger.ERROR], text</span><br><span class="line">            ))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NatterExit</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    atexit.register(<span class="keyword">lambda</span> : NatterExit._atexit[<span class="number">0</span>]())</span><br><span class="line">    _atexit = [<span class="keyword">lambda</span> : <span class="literal">None</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_atexit</span>(<span class="params">func</span>):</span><br><span class="line">        NatterExit._atexit[<span class="number">0</span>] = func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PortTest</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_lan</span>(<span class="params">self, addr, source_ip=<span class="literal">None</span>, interface=<span class="literal">None</span>, info=<span class="literal">False</span></span>):</span><br><span class="line">        print_status = Logger.info <span class="keyword">if</span> info <span class="keyword">else</span> Logger.debug</span><br><span class="line">        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            socket_set_opt(</span><br><span class="line">                sock,</span><br><span class="line">                bind_addr   = (source_ip, <span class="number">0</span>) <span class="keyword">if</span> source_ip <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                interface   = interface,</span><br><span class="line">                timeout     = <span class="number">1</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> sock.connect_ex(addr) == <span class="number">0</span>:</span><br><span class="line">                print_status(<span class="string">&quot;LAN &gt; %-21s [ OPEN ]&quot;</span> % addr_to_str(addr))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print_status(<span class="string">&quot;LAN &gt; %-21s [ CLOSED ]&quot;</span> % addr_to_str(addr))</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> (OSError, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">            print_status(<span class="string">&quot;LAN &gt; %-21s [ UNKNOWN ]&quot;</span> % addr_to_str(addr))</span><br><span class="line">            Logger.debug(<span class="string">&quot;Cannot test port %s from LAN because: %s&quot;</span> % (addr_to_str(addr), ex))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            sock.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_wan</span>(<span class="params">self, addr, source_ip=<span class="literal">None</span>, interface=<span class="literal">None</span>, info=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="comment"># only port number in addr is used, WAN IP will be ignored</span></span><br><span class="line">        print_status = Logger.info <span class="keyword">if</span> info <span class="keyword">else</span> Logger.debug</span><br><span class="line">        ret01 = <span class="variable language_">self</span>._test_ifconfigco(addr[<span class="number">1</span>], source_ip, interface)</span><br><span class="line">        <span class="keyword">if</span> ret01 == <span class="number">1</span>:</span><br><span class="line">            print_status(<span class="string">&quot;WAN &gt; %-21s [ OPEN ]&quot;</span> % addr_to_str(addr))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        ret02 = <span class="variable language_">self</span>._test_transmission(addr[<span class="number">1</span>], source_ip, interface)</span><br><span class="line">        <span class="keyword">if</span> ret02 == <span class="number">1</span>:</span><br><span class="line">            print_status(<span class="string">&quot;WAN &gt; %-21s [ OPEN ]&quot;</span> % addr_to_str(addr))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> ret01 == ret02 == -<span class="number">1</span>:</span><br><span class="line">            print_status(<span class="string">&quot;WAN &gt; %-21s [ CLOSED ]&quot;</span> % addr_to_str(addr))</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">        print_status(<span class="string">&quot;WAN &gt; %-21s [ UNKNOWN ]&quot;</span> % addr_to_str(addr))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_test_ifconfigco</span>(<span class="params">self, port, source_ip=<span class="literal">None</span>, interface=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># repo: https://github.com/mpolden/echoip</span></span><br><span class="line">        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            socket_set_opt(</span><br><span class="line">                sock,</span><br><span class="line">                bind_addr   = (source_ip, <span class="number">0</span>) <span class="keyword">if</span> source_ip <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                interface   = interface,</span><br><span class="line">                timeout     = <span class="number">8</span></span><br><span class="line">            )</span><br><span class="line">            sock.connect((<span class="string">&quot;ifconfig.co&quot;</span>, <span class="number">80</span>))</span><br><span class="line">            sock.sendall((</span><br><span class="line">                <span class="string">&quot;GET /port/%d HTTP/1.0\r\n&quot;</span></span><br><span class="line">                <span class="string">&quot;Host: ifconfig.co\r\n&quot;</span></span><br><span class="line">                <span class="string">&quot;User-Agent: curl/8.0.0 (Natter)\r\n&quot;</span></span><br><span class="line">                <span class="string">&quot;Accept: */*\r\n&quot;</span></span><br><span class="line">                <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line">                <span class="string">&quot;\r\n&quot;</span> % port</span><br><span class="line">            ).encode())</span><br><span class="line">            response = <span class="string">b&quot;&quot;</span></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                buff = sock.recv(<span class="number">4096</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> buff:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                response += buff</span><br><span class="line">            Logger.debug(<span class="string">&quot;port-test: ifconfig.co: %s&quot;</span> % response)</span><br><span class="line">            _, content = response.split(<span class="string">b&quot;\r\n\r\n&quot;</span>, <span class="number">1</span>)</span><br><span class="line">            dat = json.loads(content.decode())</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> dat[<span class="string">&quot;reachable&quot;</span>] <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> (OSError, LookupError, ValueError, TypeError, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">            Logger.debug(<span class="string">&quot;Cannot test port %d from ifconfig.co because: %s&quot;</span> % (port, ex))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            sock.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_test_transmission</span>(<span class="params">self, port, source_ip=<span class="literal">None</span>, interface=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># repo: https://github.com/transmission/portcheck</span></span><br><span class="line">        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            socket_set_opt(</span><br><span class="line">                sock,</span><br><span class="line">                bind_addr   = (source_ip, <span class="number">0</span>) <span class="keyword">if</span> source_ip <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                interface   = interface,</span><br><span class="line">                timeout     = <span class="number">8</span></span><br><span class="line">            )</span><br><span class="line">            sock.connect((<span class="string">&quot;portcheck.transmissionbt.com&quot;</span>, <span class="number">80</span>))</span><br><span class="line">            sock.sendall((</span><br><span class="line">                <span class="string">&quot;GET /%d HTTP/1.0\r\n&quot;</span></span><br><span class="line">                <span class="string">&quot;Host: portcheck.transmissionbt.com\r\n&quot;</span></span><br><span class="line">                <span class="string">&quot;User-Agent: curl/8.0.0 (Natter)\r\n&quot;</span></span><br><span class="line">                <span class="string">&quot;Accept: */*\r\n&quot;</span></span><br><span class="line">                <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line">                <span class="string">&quot;\r\n&quot;</span> % port</span><br><span class="line">            ).encode())</span><br><span class="line">            response = <span class="string">b&quot;&quot;</span></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                buff = sock.recv(<span class="number">4096</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> buff:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                response += buff</span><br><span class="line">            Logger.debug(<span class="string">&quot;port-test: portcheck.transmissionbt.com: %s&quot;</span> % response)</span><br><span class="line">            _, content = response.split(<span class="string">b&quot;\r\n\r\n&quot;</span>, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> content.strip() == <span class="string">b&quot;1&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> content.strip() == <span class="string">b&quot;0&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Unexpected response: %s&quot;</span> % response)</span><br><span class="line">        <span class="keyword">except</span> (OSError, LookupError, ValueError, TypeError, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">            Logger.debug(</span><br><span class="line">                <span class="string">&quot;Cannot test port %d from portcheck.transmissionbt.com &quot;</span></span><br><span class="line">                <span class="string">&quot;because: %s&quot;</span> % (port, ex)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            sock.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StunClient</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ServerUnavailable</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, stun_server_list, source_host=<span class="string">&quot;0.0.0.0&quot;</span>, source_port=<span class="number">0</span>,</span></span><br><span class="line"><span class="params">                 interface=<span class="literal">None</span>, udp=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> stun_server_list:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;STUN server list is empty&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.stun_server_list = stun_server_list</span><br><span class="line">        <span class="variable language_">self</span>.source_host = source_host</span><br><span class="line">        <span class="variable language_">self</span>.source_port = source_port</span><br><span class="line">        <span class="variable language_">self</span>.interface = interface</span><br><span class="line">        <span class="variable language_">self</span>.udp = udp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_mapping</span>(<span class="params">self</span>):</span><br><span class="line">        first = <span class="variable language_">self</span>.stun_server_list[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._get_mapping()</span><br><span class="line">            <span class="keyword">except</span> StunClient.ServerUnavailable <span class="keyword">as</span> ex:</span><br><span class="line">                Logger.warning(<span class="string">&quot;stun: STUN server %s is unavailable: %s&quot;</span> % (</span><br><span class="line">                    addr_to_uri(<span class="variable language_">self</span>.stun_server_list[<span class="number">0</span>], udp = <span class="variable language_">self</span>.udp), ex</span><br><span class="line">                ))</span><br><span class="line">                <span class="variable language_">self</span>.stun_server_list.append(<span class="variable language_">self</span>.stun_server_list.pop(<span class="number">0</span>))</span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.stun_server_list[<span class="number">0</span>] == first:</span><br><span class="line">                    Logger.error(<span class="string">&quot;stun: No STUN server is available right now&quot;</span>)</span><br><span class="line">                    <span class="comment"># force sleep for 10 seconds, then try the next loop</span></span><br><span class="line">                    time.sleep(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_mapping</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># ref: https://www.rfc-editor.org/rfc/rfc5389</span></span><br><span class="line">        socket_type = socket.SOCK_DGRAM <span class="keyword">if</span> <span class="variable language_">self</span>.udp <span class="keyword">else</span> socket.SOCK_STREAM</span><br><span class="line">        stun_host, stun_port = <span class="variable language_">self</span>.stun_server_list[<span class="number">0</span>]</span><br><span class="line">        sock = socket.socket(socket.AF_INET, socket_type)</span><br><span class="line">        socket_set_opt(</span><br><span class="line">            sock,</span><br><span class="line">            reuse       = <span class="literal">True</span>,</span><br><span class="line">            bind_addr   = (<span class="variable language_">self</span>.source_host, <span class="variable language_">self</span>.source_port),</span><br><span class="line">            interface   = <span class="variable language_">self</span>.interface,</span><br><span class="line">            timeout     = <span class="number">3</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sock.connect((stun_host, stun_port))</span><br><span class="line">            inner_addr = sock.getsockname()</span><br><span class="line">            <span class="variable language_">self</span>.source_host, <span class="variable language_">self</span>.source_port = inner_addr</span><br><span class="line">            sock.send(struct.pack(</span><br><span class="line">                <span class="string">&quot;!LLLLL&quot;</span>, <span class="number">0x00010000</span>, <span class="number">0x2112a442</span>, <span class="number">0x4e415452</span>,</span><br><span class="line">                random.getrandbits(<span class="number">32</span>), random.getrandbits(<span class="number">32</span>)</span><br><span class="line">            ))</span><br><span class="line">            buff = sock.recv(<span class="number">1500</span>)</span><br><span class="line">            ip = port = <span class="number">0</span></span><br><span class="line">            payload = buff[<span class="number">20</span>:]</span><br><span class="line">            <span class="keyword">while</span> payload:</span><br><span class="line">                attr_type, attr_len = struct.unpack(<span class="string">&quot;!HH&quot;</span>, payload[:<span class="number">4</span>])</span><br><span class="line">                <span class="keyword">if</span> attr_type <span class="keyword">in</span> [<span class="number">1</span>, <span class="number">32</span>]:</span><br><span class="line">                    _, _, port, ip = struct.unpack(<span class="string">&quot;!BBHL&quot;</span>, payload[<span class="number">4</span>:<span class="number">4</span>+attr_len])</span><br><span class="line">                    <span class="keyword">if</span> attr_type == <span class="number">32</span>:</span><br><span class="line">                        port ^= <span class="number">0x2112</span></span><br><span class="line">                        ip ^= <span class="number">0x2112a442</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                payload = payload[<span class="number">4</span> + attr_len:]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid STUN response&quot;</span>)</span><br><span class="line">            outer_addr = socket.inet_ntop(socket.AF_INET, struct.pack(<span class="string">&quot;!L&quot;</span>, ip)), port</span><br><span class="line">            Logger.debug(<span class="string">&quot;stun: Got address %s from %s, source %s&quot;</span> % (</span><br><span class="line">                addr_to_uri(outer_addr, udp=<span class="variable language_">self</span>.udp),</span><br><span class="line">                addr_to_uri((stun_host, stun_port), udp=<span class="variable language_">self</span>.udp),</span><br><span class="line">                addr_to_uri(inner_addr, udp=<span class="variable language_">self</span>.udp)</span><br><span class="line">            ))</span><br><span class="line">            <span class="keyword">return</span> inner_addr, outer_addr</span><br><span class="line">        <span class="keyword">except</span> (OSError, ValueError, struct.error, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">            <span class="keyword">raise</span> StunClient.ServerUnavailable(ex)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            sock.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KeepAlive</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host, port, source_host, source_port, interface=<span class="literal">None</span>, udp=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.sock = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.host = host</span><br><span class="line">        <span class="variable language_">self</span>.port = port</span><br><span class="line">        <span class="variable language_">self</span>.source_host = source_host</span><br><span class="line">        <span class="variable language_">self</span>.source_port = source_port</span><br><span class="line">        <span class="variable language_">self</span>.interface = interface</span><br><span class="line">        <span class="variable language_">self</span>.udp = udp</span><br><span class="line">        <span class="variable language_">self</span>.reconn = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.sock:</span><br><span class="line">            <span class="variable language_">self</span>.sock.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_connect</span>(<span class="params">self</span>):</span><br><span class="line">        sock_type = socket.SOCK_DGRAM <span class="keyword">if</span> <span class="variable language_">self</span>.udp <span class="keyword">else</span> socket.SOCK_STREAM</span><br><span class="line">        sock = socket.socket(socket.AF_INET, sock_type)</span><br><span class="line">        socket_set_opt(</span><br><span class="line">            sock,</span><br><span class="line">            reuse       = <span class="literal">True</span>,</span><br><span class="line">            bind_addr   = (<span class="variable language_">self</span>.source_host, <span class="variable language_">self</span>.source_port),</span><br><span class="line">            interface   = <span class="variable language_">self</span>.interface,</span><br><span class="line">            timeout     = <span class="number">3</span></span><br><span class="line">        )</span><br><span class="line">        sock.connect((<span class="variable language_">self</span>.host, <span class="variable language_">self</span>.port))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.udp:</span><br><span class="line">            Logger.debug(<span class="string">&quot;keep-alive: Connected to host %s&quot;</span> % (</span><br><span class="line">                addr_to_uri((<span class="variable language_">self</span>.host, <span class="variable language_">self</span>.port), udp=<span class="variable language_">self</span>.udp)</span><br><span class="line">            ))</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.reconn:</span><br><span class="line">                Logger.info(<span class="string">&quot;keep-alive: connection restored&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.reconn = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.sock = sock</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">keep_alive</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.sock <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="variable language_">self</span>._connect()</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.udp:</span><br><span class="line">            <span class="variable language_">self</span>._keep_alive_udp()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>._keep_alive_tcp()</span><br><span class="line">        Logger.debug(<span class="string">&quot;keep-alive: OK&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.sock <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="variable language_">self</span>.sock.close()</span><br><span class="line">            <span class="variable language_">self</span>.sock = <span class="literal">None</span></span><br><span class="line">            <span class="variable language_">self</span>.reconn = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_keep_alive_tcp</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># send a HTTP request</span></span><br><span class="line">        <span class="variable language_">self</span>.sock.sendall((</span><br><span class="line">            <span class="string">&quot;HEAD /natter-keep-alive HTTP/1.1\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Host: %s\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;User-Agent: curl/8.0.0 (Natter)\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Accept: */*\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Connection: keep-alive\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span> % <span class="variable language_">self</span>.host</span><br><span class="line">        ).encode())</span><br><span class="line">        buff = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                buff = <span class="variable language_">self</span>.sock.recv(<span class="number">4096</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> buff:</span><br><span class="line">                    <span class="keyword">raise</span> OSError(<span class="string">&quot;Keep-alive server closed connection&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> socket.timeout <span class="keyword">as</span> ex:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> buff:</span><br><span class="line">                <span class="keyword">raise</span> ex</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_keep_alive_udp</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># send a DNS request</span></span><br><span class="line">        <span class="variable language_">self</span>.sock.send(</span><br><span class="line">            struct.pack(</span><br><span class="line">                <span class="string">&quot;!HHHHHH&quot;</span>, random.getrandbits(<span class="number">16</span>), <span class="number">0x0100</span>, <span class="number">0x0001</span>, <span class="number">0x0000</span>, <span class="number">0x0000</span>, <span class="number">0x0000</span></span><br><span class="line">            ) + <span class="string">b&quot;\x09keepalive\x06natter\x00&quot;</span> + struct.pack(<span class="string">&quot;!HH&quot;</span>, <span class="number">0x0001</span>, <span class="number">0x0001</span>)</span><br><span class="line">        )</span><br><span class="line">        buff = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                buff = <span class="variable language_">self</span>.sock.recv(<span class="number">1500</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> buff:</span><br><span class="line">                    <span class="keyword">raise</span> OSError(<span class="string">&quot;Keep-alive server closed connection&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> socket.timeout <span class="keyword">as</span> ex:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> buff:</span><br><span class="line">                <span class="keyword">raise</span> ex</span><br><span class="line">            <span class="comment"># fix: Keep-alive cause STUN socket timeout on Windows</span></span><br><span class="line">            <span class="keyword">if</span> sys.platform == <span class="string">&quot;win32&quot;</span>:</span><br><span class="line">                <span class="variable language_">self</span>.reset()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardNone</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="comment"># Do nothing. Don&#x27;t forward.</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_forward</span>(<span class="params">self, ip, port, toip, toport, udp=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_forward</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardTestServer</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.sock = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.sock_type = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.buff_size = <span class="number">8192</span></span><br><span class="line">        <span class="variable language_">self</span>.timeout = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Start a socket server for testing purpose</span></span><br><span class="line">    <span class="comment"># target address is ignored</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_forward</span>(<span class="params">self, ip, port, toip, toport, udp=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.sock_type = socket.SOCK_DGRAM <span class="keyword">if</span> udp <span class="keyword">else</span> socket.SOCK_STREAM</span><br><span class="line">        <span class="variable language_">self</span>.sock = socket.socket(socket.AF_INET, <span class="variable language_">self</span>.sock_type)</span><br><span class="line">        socket_set_opt(</span><br><span class="line">            <span class="variable language_">self</span>.sock,</span><br><span class="line">            reuse       = <span class="literal">True</span>,</span><br><span class="line">            bind_addr   = (<span class="string">&quot;&quot;</span>, port)</span><br><span class="line">        )</span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-test: Starting test server at %s&quot;</span> % addr_to_uri((ip, port), udp=udp))</span><br><span class="line">        <span class="keyword">if</span> udp:</span><br><span class="line">            th = start_daemon_thread(<span class="variable language_">self</span>._test_server_run_udp)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            th = start_daemon_thread(<span class="variable language_">self</span>._test_server_run_http)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> th.is_alive():</span><br><span class="line">            <span class="keyword">raise</span> OSError(<span class="string">&quot;Test server thread exited too quickly&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_test_server_run_http</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.sock.listen(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="variable language_">self</span>.sock.fileno() != -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                conn, addr = <span class="variable language_">self</span>.sock.accept()</span><br><span class="line">                Logger.debug(<span class="string">&quot;fwd-test: got client %s&quot;</span> % (addr,))</span><br><span class="line">            <span class="keyword">except</span> (OSError, socket.error):</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                conn.settimeout(<span class="variable language_">self</span>.timeout)</span><br><span class="line">                conn.recv(<span class="variable language_">self</span>.buff_size)</span><br><span class="line">                content = <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;hr/&gt;Natter&lt;/body&gt;&lt;/html&gt;&quot;</span></span><br><span class="line">                content_len = <span class="built_in">len</span>(content.encode())</span><br><span class="line">                data = (</span><br><span class="line">                    <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;Content-Type: text/html\r\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;Content-Length: %d\r\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;Server: Natter\r\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;%s\r\n&quot;</span> % (content_len, content)</span><br><span class="line">                ).encode()</span><br><span class="line">                conn.sendall(data)</span><br><span class="line">                conn.shutdown(socket.SHUT_RDWR)</span><br><span class="line">            <span class="keyword">except</span> (OSError, socket.error):</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                conn.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_test_server_run_udp</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="variable language_">self</span>.sock.fileno() != -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                msg, addr = <span class="variable language_">self</span>.sock.recvfrom(<span class="variable language_">self</span>.buff_size)</span><br><span class="line">                Logger.debug(<span class="string">&quot;fwd-test: got client %s&quot;</span> % (addr,))</span><br><span class="line">                <span class="variable language_">self</span>.sock.sendto(<span class="string">b&quot;It works! - Natter\r\n&quot;</span>, addr)</span><br><span class="line">            <span class="keyword">except</span> (OSError, socket.error):</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_forward</span>(<span class="params">self</span>):</span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-test: Stopping test server&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.sock.close()</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardIptables</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, snat=<span class="literal">False</span>, sudo=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.rules = []</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.min_ver = (<span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.curr_ver = (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.snat = snat</span><br><span class="line">        <span class="variable language_">self</span>.sudo = sudo</span><br><span class="line">        <span class="keyword">if</span> sudo:</span><br><span class="line">            <span class="variable language_">self</span>.iptables_cmd = [<span class="string">&quot;sudo&quot;</span>, <span class="string">&quot;-n&quot;</span>, <span class="string">&quot;iptables&quot;</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.iptables_cmd = [<span class="string">&quot;iptables&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._iptables_check():</span><br><span class="line">            <span class="keyword">raise</span> OSError(<span class="string">&quot;iptables &gt;= %s not available&quot;</span> % <span class="built_in">str</span>(<span class="variable language_">self</span>.min_ver))</span><br><span class="line">        <span class="comment"># wait for iptables lock, since iptables 1.4.20</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.curr_ver &gt;= (<span class="number">1</span>, <span class="number">4</span>, <span class="number">20</span>):</span><br><span class="line">            <span class="variable language_">self</span>.iptables_cmd += [<span class="string">&quot;-w&quot;</span>]</span><br><span class="line">        <span class="variable language_">self</span>._iptables_init()</span><br><span class="line">        <span class="variable language_">self</span>._iptables_clean()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.active:</span><br><span class="line">            <span class="variable language_">self</span>.stop_forward()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_iptables_check</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> os.name != <span class="string">&quot;posix&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.sudo <span class="keyword">and</span> os.getuid() != <span class="number">0</span>:</span><br><span class="line">            Logger.warning(<span class="string">&quot;fwd-iptables: You are not root&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            output = subprocess.check_output(</span><br><span class="line">                <span class="variable language_">self</span>.iptables_cmd + [<span class="string">&quot;--version&quot;</span>]</span><br><span class="line">            ).decode()</span><br><span class="line">        <span class="keyword">except</span> (OSError, subprocess.CalledProcessError) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        m = re.search(<span class="string">r&quot;iptables v([0-9]+)\.([0-9]+)\.([0-9]+)&quot;</span>, output)</span><br><span class="line">        <span class="keyword">if</span> m:</span><br><span class="line">            <span class="variable language_">self</span>.curr_ver = <span class="built_in">tuple</span>(<span class="built_in">int</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> m.groups())</span><br><span class="line">            Logger.debug(<span class="string">&quot;fwd-iptables: Found iptables %s&quot;</span> % <span class="built_in">str</span>(<span class="variable language_">self</span>.curr_ver))</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.curr_ver &lt; <span class="variable language_">self</span>.min_ver:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># check nat table</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            subprocess.check_output(</span><br><span class="line">                <span class="variable language_">self</span>.iptables_cmd + [<span class="string">&quot;-t&quot;</span>, <span class="string">&quot;nat&quot;</span>, <span class="string">&quot;--list-rules&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> (OSError, subprocess.CalledProcessError) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_iptables_init</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            subprocess.check_output(</span><br><span class="line">                <span class="variable language_">self</span>.iptables_cmd + [<span class="string">&quot;-t&quot;</span>, <span class="string">&quot;nat&quot;</span>, <span class="string">&quot;--list-rules&quot;</span>, <span class="string">&quot;NATTER&quot;</span>],</span><br><span class="line">                stderr=subprocess.STDOUT</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">except</span> subprocess.CalledProcessError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-iptables: Creating Natter chain&quot;</span>)</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.iptables_cmd + [<span class="string">&quot;-t&quot;</span>, <span class="string">&quot;nat&quot;</span>, <span class="string">&quot;-N&quot;</span>, <span class="string">&quot;NATTER&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.iptables_cmd + [<span class="string">&quot;-t&quot;</span>, <span class="string">&quot;nat&quot;</span>, <span class="string">&quot;-I&quot;</span>, <span class="string">&quot;PREROUTING&quot;</span>, <span class="string">&quot;-j&quot;</span>, <span class="string">&quot;NATTER&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.iptables_cmd + [<span class="string">&quot;-t&quot;</span>, <span class="string">&quot;nat&quot;</span>, <span class="string">&quot;-I&quot;</span>, <span class="string">&quot;OUTPUT&quot;</span>, <span class="string">&quot;-j&quot;</span>, <span class="string">&quot;NATTER&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.iptables_cmd + [<span class="string">&quot;-t&quot;</span>, <span class="string">&quot;nat&quot;</span>, <span class="string">&quot;-N&quot;</span>, <span class="string">&quot;NATTER_SNAT&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.iptables_cmd + [<span class="string">&quot;-t&quot;</span>, <span class="string">&quot;nat&quot;</span>, <span class="string">&quot;-I&quot;</span>, <span class="string">&quot;POSTROUTING&quot;</span>, <span class="string">&quot;-j&quot;</span>, <span class="string">&quot;NATTER_SNAT&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.iptables_cmd + [<span class="string">&quot;-t&quot;</span>, <span class="string">&quot;nat&quot;</span>, <span class="string">&quot;-I&quot;</span>, <span class="string">&quot;INPUT&quot;</span>, <span class="string">&quot;-j&quot;</span>, <span class="string">&quot;NATTER_SNAT&quot;</span>]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_iptables_clean</span>(<span class="params">self</span>):</span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-iptables: Cleaning up Natter rules&quot;</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="variable language_">self</span>.rules:</span><br><span class="line">            rule = <span class="variable language_">self</span>.rules.pop()</span><br><span class="line">            rule_rm = [<span class="string">&quot;-D&quot;</span> <span class="keyword">if</span> arg <span class="keyword">in</span> (<span class="string">&quot;-I&quot;</span>, <span class="string">&quot;-A&quot;</span>) <span class="keyword">else</span> arg <span class="keyword">for</span> arg <span class="keyword">in</span> rule]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                subprocess.check_output(</span><br><span class="line">                    <span class="variable language_">self</span>.iptables_cmd + rule_rm,</span><br><span class="line">                    stderr=subprocess.STDOUT</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> ex:</span><br><span class="line">                Logger.error(<span class="string">&quot;fwd-iptables: Failed to execute %s: %s&quot;</span> % (ex.cmd, ex.output))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_forward</span>(<span class="params">self, ip, port, toip, toport, udp=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">if</span> ip != toip:</span><br><span class="line">            <span class="variable language_">self</span>._check_sys_forward_config()</span><br><span class="line">        <span class="keyword">if</span> (ip, port) == (toip, toport):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Cannot forward to the same address %s&quot;</span> % addr_to_str((ip, port)))</span><br><span class="line">        proto = <span class="string">&quot;udp&quot;</span> <span class="keyword">if</span> udp <span class="keyword">else</span> <span class="string">&quot;tcp&quot;</span></span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-iptables: Adding rule %s forward to %s&quot;</span> % (</span><br><span class="line">            addr_to_uri((ip, port), udp=udp), addr_to_uri((toip, toport), udp=udp)</span><br><span class="line">        ))</span><br><span class="line">        rule = [</span><br><span class="line">            <span class="string">&quot;-t&quot;</span>,       <span class="string">&quot;nat&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-I&quot;</span>,       <span class="string">&quot;NATTER&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-p&quot;</span>,       proto,</span><br><span class="line">            <span class="string">&quot;--dst&quot;</span>,    ip,</span><br><span class="line">            <span class="string">&quot;--dport&quot;</span>,  <span class="string">&quot;%d&quot;</span> % port,</span><br><span class="line">            <span class="string">&quot;-j&quot;</span>,       <span class="string">&quot;DNAT&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--to-destination&quot;</span>, <span class="string">&quot;%s:%d&quot;</span> % (toip, toport)</span><br><span class="line">        ]</span><br><span class="line">        subprocess.check_output(<span class="variable language_">self</span>.iptables_cmd + rule)</span><br><span class="line">        <span class="variable language_">self</span>.rules.append(rule)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.snat:</span><br><span class="line">            rule = [</span><br><span class="line">                <span class="string">&quot;-t&quot;</span>,       <span class="string">&quot;nat&quot;</span>,</span><br><span class="line">                <span class="string">&quot;-I&quot;</span>,       <span class="string">&quot;NATTER_SNAT&quot;</span>,</span><br><span class="line">                <span class="string">&quot;-p&quot;</span>,       proto,</span><br><span class="line">                <span class="string">&quot;--dst&quot;</span>,    toip,</span><br><span class="line">                <span class="string">&quot;--dport&quot;</span>,  <span class="string">&quot;%d&quot;</span> % toport,</span><br><span class="line">                <span class="string">&quot;-j&quot;</span>,       <span class="string">&quot;SNAT&quot;</span>,</span><br><span class="line">                <span class="string">&quot;--to-source&quot;</span>, ip</span><br><span class="line">            ]</span><br><span class="line">            subprocess.check_output(<span class="variable language_">self</span>.iptables_cmd + rule)</span><br><span class="line">            <span class="variable language_">self</span>.rules.append(rule)</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_forward</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>._iptables_clean()</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_sys_forward_config</span>(<span class="params">self</span>):</span><br><span class="line">        fpath = <span class="string">&quot;/proc/sys/net/ipv4/ip_forward&quot;</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(fpath):</span><br><span class="line">            fin = <span class="built_in">open</span>(fpath, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">            buff = fin.read()</span><br><span class="line">            fin.close()</span><br><span class="line">            <span class="keyword">if</span> buff.strip() != <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                <span class="keyword">raise</span> OSError(<span class="string">&quot;IP forwarding is not allowed. Please do `sysctl net.ipv4.ip_forward=1`&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            Logger.warning(<span class="string">&quot;fwd-iptables: &#x27;%s&#x27; not found&quot;</span> % <span class="built_in">str</span>(fpath))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardSudoIptables</span>(<span class="title class_ inherited__">ForwardIptables</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(sudo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardIptablesSnat</span>(<span class="title class_ inherited__">ForwardIptables</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(snat=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardSudoIptablesSnat</span>(<span class="title class_ inherited__">ForwardIptables</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(snat=<span class="literal">True</span>, sudo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardNftables</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, snat=<span class="literal">False</span>, sudo=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.handle = -<span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.handle_snat = -<span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.min_ver = (<span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.snat = snat</span><br><span class="line">        <span class="variable language_">self</span>.sudo = sudo</span><br><span class="line">        <span class="keyword">if</span> sudo:</span><br><span class="line">            <span class="variable language_">self</span>.nftables_cmd = [<span class="string">&quot;sudo&quot;</span>, <span class="string">&quot;-n&quot;</span>, <span class="string">&quot;nft&quot;</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.nftables_cmd = [<span class="string">&quot;nft&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._nftables_check():</span><br><span class="line">            <span class="keyword">raise</span> OSError(<span class="string">&quot;nftables &gt;= %s not available&quot;</span> % <span class="built_in">str</span>(<span class="variable language_">self</span>.min_ver))</span><br><span class="line">        <span class="variable language_">self</span>._nftables_init()</span><br><span class="line">        <span class="variable language_">self</span>._nftables_clean()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.active:</span><br><span class="line">            <span class="variable language_">self</span>.stop_forward()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_nftables_check</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> os.name != <span class="string">&quot;posix&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.sudo <span class="keyword">and</span> os.getuid() != <span class="number">0</span>:</span><br><span class="line">            Logger.warning(<span class="string">&quot;fwd-nftables: You are not root&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            output = subprocess.check_output(</span><br><span class="line">                <span class="variable language_">self</span>.nftables_cmd + [<span class="string">&quot;--version&quot;</span>]</span><br><span class="line">            ).decode()</span><br><span class="line">        <span class="keyword">except</span> (OSError, subprocess.CalledProcessError) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        m = re.search(<span class="string">r&quot;nftables v([0-9]+)\.([0-9]+)\.([0-9]+)&quot;</span>, output)</span><br><span class="line">        <span class="keyword">if</span> m:</span><br><span class="line">            curr_ver = <span class="built_in">tuple</span>(<span class="built_in">int</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> m.groups())</span><br><span class="line">            Logger.debug(<span class="string">&quot;fwd-nftables: Found nftables %s&quot;</span> % <span class="built_in">str</span>(curr_ver))</span><br><span class="line">            <span class="keyword">if</span> curr_ver &lt; <span class="variable language_">self</span>.min_ver:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># check nat table</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            subprocess.check_output(</span><br><span class="line">                <span class="variable language_">self</span>.nftables_cmd + [<span class="string">&quot;list table ip nat&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> (OSError, subprocess.CalledProcessError) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_nftables_init</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            subprocess.check_output(</span><br><span class="line">                <span class="variable language_">self</span>.nftables_cmd + [<span class="string">&quot;list chain ip nat NATTER&quot;</span>],</span><br><span class="line">                stderr=subprocess.STDOUT</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">except</span> subprocess.CalledProcessError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-nftables: Creating Natter chain&quot;</span>)</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.nftables_cmd + [<span class="string">&quot;add chain ip nat NATTER&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.nftables_cmd + [<span class="string">&quot;insert rule ip nat PREROUTING counter jump NATTER&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.nftables_cmd + [<span class="string">&quot;insert rule ip nat OUTPUT counter jump NATTER&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.nftables_cmd + [<span class="string">&quot;add chain ip nat NATTER_SNAT&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.nftables_cmd + [<span class="string">&quot;insert rule ip nat PREROUTING counter jump NATTER_SNAT&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        subprocess.check_output(</span><br><span class="line">            <span class="variable language_">self</span>.nftables_cmd + [<span class="string">&quot;insert rule ip nat OUTPUT counter jump NATTER_SNAT&quot;</span>]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_nftables_clean</span>(<span class="params">self</span>):</span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-nftables: Cleaning up Natter rules&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.handle &gt; <span class="number">0</span>:</span><br><span class="line">            subprocess.check_output(</span><br><span class="line">                <span class="variable language_">self</span>.nftables_cmd + [<span class="string">&quot;delete rule ip nat NATTER handle %d&quot;</span> % <span class="variable language_">self</span>.handle]</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.handle_snat &gt; <span class="number">0</span>:</span><br><span class="line">            subprocess.check_output(</span><br><span class="line">                <span class="variable language_">self</span>.nftables_cmd + [<span class="string">&quot;delete rule ip nat NATTER_SNAT handle %d&quot;</span> % <span class="variable language_">self</span>.handle_snat]</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_forward</span>(<span class="params">self, ip, port, toip, toport, udp=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">if</span> ip != toip:</span><br><span class="line">            <span class="variable language_">self</span>._check_sys_forward_config()</span><br><span class="line">        <span class="keyword">if</span> (ip, port) == (toip, toport):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Cannot forward to the same address %s&quot;</span> % addr_to_str((ip, port)))</span><br><span class="line">        proto = <span class="string">&quot;udp&quot;</span> <span class="keyword">if</span> udp <span class="keyword">else</span> <span class="string">&quot;tcp&quot;</span></span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-nftables: Adding rule %s forward to %s&quot;</span> % (</span><br><span class="line">            addr_to_uri((ip, port), udp=udp), addr_to_uri((toip, toport), udp=udp)</span><br><span class="line">        ))</span><br><span class="line">        output = subprocess.check_output(<span class="variable language_">self</span>.nftables_cmd + [</span><br><span class="line">            <span class="string">&quot;--echo&quot;</span>, <span class="string">&quot;--handle&quot;</span>,</span><br><span class="line">            <span class="string">&quot;insert rule ip nat NATTER ip daddr %s %s dport %d counter dnat to %s:%d&quot;</span> % (</span><br><span class="line">                ip, proto, port, toip, toport</span><br><span class="line">            )</span><br><span class="line">        ]).decode()</span><br><span class="line">        m = re.search(<span class="string">r&quot;# handle ([0-9]+)$&quot;</span>, output, re.MULTILINE)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> m:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Unknown nftables handle&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.handle = <span class="built_in">int</span>(m.group(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.snat:</span><br><span class="line">            output = subprocess.check_output(<span class="variable language_">self</span>.nftables_cmd + [</span><br><span class="line">                <span class="string">&quot;--echo&quot;</span>, <span class="string">&quot;--handle&quot;</span>,</span><br><span class="line">                <span class="string">&quot;insert rule ip nat NATTER_SNAT ip daddr %s %s dport %d counter snat to %s&quot;</span> % (</span><br><span class="line">                    toip, proto, toport, ip</span><br><span class="line">                )</span><br><span class="line">            ]).decode()</span><br><span class="line">            m = re.search(<span class="string">r&quot;# handle ([0-9]+)$&quot;</span>, output, re.MULTILINE)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> m:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;Unknown nftables handle&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.handle_snat = <span class="built_in">int</span>(m.group(<span class="number">1</span>))</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_forward</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>._nftables_clean()</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_sys_forward_config</span>(<span class="params">self</span>):</span><br><span class="line">        fpath = <span class="string">&quot;/proc/sys/net/ipv4/ip_forward&quot;</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(fpath):</span><br><span class="line">            fin = <span class="built_in">open</span>(fpath, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">            buff = fin.read()</span><br><span class="line">            fin.close()</span><br><span class="line">            <span class="keyword">if</span> buff.strip() != <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                <span class="keyword">raise</span> OSError(<span class="string">&quot;IP forwarding is disabled by system. Please do `sysctl net.ipv4.ip_forward=1`&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            Logger.warning(<span class="string">&quot;fwd-nftables: &#x27;%s&#x27; not found&quot;</span> % <span class="built_in">str</span>(fpath))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardSudoNftables</span>(<span class="title class_ inherited__">ForwardNftables</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(sudo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardNftablesSnat</span>(<span class="title class_ inherited__">ForwardNftables</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(snat=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardSudoNftablesSnat</span>(<span class="title class_ inherited__">ForwardNftables</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(snat=<span class="literal">True</span>, sudo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardGost</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.min_ver = (<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">        <span class="variable language_">self</span>.proc = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.udp_timeout = <span class="number">60</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._gost_check():</span><br><span class="line">            <span class="keyword">raise</span> OSError(<span class="string">&quot;gost &gt;= %s not available&quot;</span> % <span class="built_in">str</span>(<span class="variable language_">self</span>.min_ver))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.active:</span><br><span class="line">            <span class="variable language_">self</span>.stop_forward()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_gost_check</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            output = subprocess.check_output(</span><br><span class="line">                [<span class="string">&quot;gost&quot;</span>, <span class="string">&quot;-V&quot;</span>], stderr=subprocess.STDOUT</span><br><span class="line">            ).decode()</span><br><span class="line">        <span class="keyword">except</span> (OSError, subprocess.CalledProcessError) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        m = re.search(<span class="string">r&quot;gost v?([0-9]+)\.([0-9]+)&quot;</span>, output)</span><br><span class="line">        <span class="keyword">if</span> m:</span><br><span class="line">            current_ver = <span class="built_in">tuple</span>(<span class="built_in">int</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> m.groups())</span><br><span class="line">            Logger.debug(<span class="string">&quot;fwd-gost: Found gost %s&quot;</span> % <span class="built_in">str</span>(current_ver))</span><br><span class="line">            <span class="keyword">return</span> current_ver &gt;= <span class="variable language_">self</span>.min_ver</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_forward</span>(<span class="params">self, ip, port, toip, toport, udp=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">if</span> (ip, port) == (toip, toport):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Cannot forward to the same address %s&quot;</span> % addr_to_str((ip, port)))</span><br><span class="line">        proto = <span class="string">&quot;udp&quot;</span> <span class="keyword">if</span> udp <span class="keyword">else</span> <span class="string">&quot;tcp&quot;</span></span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-gost: Starting gost %s forward to %s&quot;</span> % (</span><br><span class="line">            addr_to_uri((ip, port), udp=udp), addr_to_uri((toip, toport), udp=udp)</span><br><span class="line">        ))</span><br><span class="line">        gost_arg = <span class="string">&quot;-L=%s://:%d/%s:%d&quot;</span> % (proto, port, toip, toport)</span><br><span class="line">        <span class="keyword">if</span> udp:</span><br><span class="line">            gost_arg += <span class="string">&quot;?ttl=%ds&quot;</span> % <span class="variable language_">self</span>.udp_timeout</span><br><span class="line">        <span class="variable language_">self</span>.proc = subprocess.Popen([<span class="string">&quot;gost&quot;</span>, gost_arg])</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.proc.poll() <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> OSError(<span class="string">&quot;gost exited too quickly&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_forward</span>(<span class="params">self</span>):</span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-gost: Stopping gost&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.proc <span class="keyword">and</span> <span class="variable language_">self</span>.proc.returncode <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="variable language_">self</span>.proc.terminate()</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardSocat</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.min_ver = (<span class="number">1</span>, <span class="number">7</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="variable language_">self</span>.proc = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.udp_timeout = <span class="number">60</span></span><br><span class="line">        <span class="variable language_">self</span>.max_children = <span class="number">128</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._socat_check():</span><br><span class="line">            <span class="keyword">raise</span> OSError(<span class="string">&quot;socat &gt;= %s not available&quot;</span> % <span class="built_in">str</span>(<span class="variable language_">self</span>.min_ver))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.active:</span><br><span class="line">            <span class="variable language_">self</span>.stop_forward()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_socat_check</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            output = subprocess.check_output(</span><br><span class="line">                [<span class="string">&quot;socat&quot;</span>, <span class="string">&quot;-V&quot;</span>], stderr=subprocess.STDOUT</span><br><span class="line">            ).decode()</span><br><span class="line">        <span class="keyword">except</span> (OSError, subprocess.CalledProcessError) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        m = re.search(<span class="string">r&quot;socat version ([0-9]+)\.([0-9]+)\.([0-9]+)&quot;</span>, output)</span><br><span class="line">        <span class="keyword">if</span> m:</span><br><span class="line">            current_ver = <span class="built_in">tuple</span>(<span class="built_in">int</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> m.groups())</span><br><span class="line">            Logger.debug(<span class="string">&quot;fwd-socat: Found socat %s&quot;</span> % <span class="built_in">str</span>(current_ver))</span><br><span class="line">            <span class="keyword">return</span> current_ver &gt;= <span class="variable language_">self</span>.min_ver</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_forward</span>(<span class="params">self, ip, port, toip, toport, udp=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">if</span> (ip, port) == (toip, toport):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Cannot forward to the same address %s&quot;</span> % addr_to_str((ip, port)))</span><br><span class="line">        proto = <span class="string">&quot;UDP&quot;</span> <span class="keyword">if</span> udp <span class="keyword">else</span> <span class="string">&quot;TCP&quot;</span></span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-socat: Starting socat %s forward to %s&quot;</span> % (</span><br><span class="line">            addr_to_uri((ip, port), udp=udp), addr_to_uri((toip, toport), udp=udp)</span><br><span class="line">        ))</span><br><span class="line">        <span class="keyword">if</span> udp:</span><br><span class="line">            socat_cmd = [<span class="string">&quot;socat&quot;</span>, <span class="string">&quot;-T%d&quot;</span> % <span class="variable language_">self</span>.udp_timeout]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            socat_cmd = [<span class="string">&quot;socat&quot;</span>]</span><br><span class="line">        <span class="variable language_">self</span>.proc = subprocess.Popen(socat_cmd + [</span><br><span class="line">            <span class="string">&quot;%s4-LISTEN:%d,reuseaddr,fork,max-children=%d&quot;</span> % (proto, port, <span class="variable language_">self</span>.max_children),</span><br><span class="line">            <span class="string">&quot;%s4:%s:%d&quot;</span> % (proto, toip, toport)</span><br><span class="line">        ])</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.proc.poll() <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> OSError(<span class="string">&quot;socat exited too quickly&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_forward</span>(<span class="params">self</span>):</span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-socat: Stopping socat&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.proc <span class="keyword">and</span> <span class="variable language_">self</span>.proc.returncode <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="variable language_">self</span>.proc.terminate()</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForwardSocket</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.sock = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.sock_type = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.outbound_addr = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.buff_size = <span class="number">8192</span></span><br><span class="line">        <span class="variable language_">self</span>.udp_timeout = <span class="number">60</span></span><br><span class="line">        <span class="variable language_">self</span>.max_threads = <span class="number">128</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.active:</span><br><span class="line">            <span class="variable language_">self</span>.stop_forward()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_forward</span>(<span class="params">self, ip, port, toip, toport, udp=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">if</span> (ip, port) == (toip, toport):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Cannot forward to the same address %s&quot;</span> % addr_to_str((ip, port)))</span><br><span class="line">        <span class="variable language_">self</span>.sock_type = socket.SOCK_DGRAM <span class="keyword">if</span> udp <span class="keyword">else</span> socket.SOCK_STREAM</span><br><span class="line">        <span class="variable language_">self</span>.sock = socket.socket(socket.AF_INET, <span class="variable language_">self</span>.sock_type)</span><br><span class="line">        socket_set_opt(</span><br><span class="line">            <span class="variable language_">self</span>.sock,</span><br><span class="line">            reuse       = <span class="literal">True</span>,</span><br><span class="line">            bind_addr   = (<span class="string">&quot;&quot;</span>, port)</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.outbound_addr = toip, toport</span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-socket: Starting socket %s forward to %s&quot;</span> % (</span><br><span class="line">            addr_to_uri((ip, port), udp=udp), addr_to_uri((toip, toport), udp=udp)</span><br><span class="line">        ))</span><br><span class="line">        <span class="keyword">if</span> udp:</span><br><span class="line">            th = start_daemon_thread(<span class="variable language_">self</span>._socket_udp_recvfrom)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            th = start_daemon_thread(<span class="variable language_">self</span>._socket_tcp_listen)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> th.is_alive():</span><br><span class="line">            <span class="keyword">raise</span> OSError(<span class="string">&quot;Socket thread exited too quickly&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_socket_tcp_listen</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.sock.listen(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                sock_inbound, _ = <span class="variable language_">self</span>.sock.accept()</span><br><span class="line">            <span class="keyword">except</span> (OSError, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> closed_socket_ex(ex):</span><br><span class="line">                    Logger.error(<span class="string">&quot;fwd-socket: socket listening thread is exiting: %s&quot;</span> % ex)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            sock_outbound = socket.socket(socket.AF_INET, <span class="variable language_">self</span>.sock_type)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                sock_outbound.settimeout(<span class="number">3</span>)</span><br><span class="line">                sock_outbound.connect(<span class="variable language_">self</span>.outbound_addr)</span><br><span class="line">                sock_outbound.settimeout(<span class="literal">None</span>)</span><br><span class="line">                <span class="keyword">if</span> threading.active_count() &gt;= <span class="variable language_">self</span>.max_threads:</span><br><span class="line">                    <span class="keyword">raise</span> OSError(<span class="string">&quot;Too many threads&quot;</span>)</span><br><span class="line">                start_daemon_thread(<span class="variable language_">self</span>._socket_tcp_forward, args=(sock_inbound, sock_outbound))</span><br><span class="line">                start_daemon_thread(<span class="variable language_">self</span>._socket_tcp_forward, args=(sock_outbound, sock_inbound))</span><br><span class="line">            <span class="keyword">except</span> (OSError, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">                Logger.error(<span class="string">&quot;fwd-socket: cannot forward port: %s&quot;</span> % ex)</span><br><span class="line">                sock_inbound.close()</span><br><span class="line">                sock_outbound.close()</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_socket_tcp_forward</span>(<span class="params">self, sock_to_recv, sock_to_send</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> sock_to_recv.fileno() != -<span class="number">1</span>:</span><br><span class="line">                buff = sock_to_recv.recv(<span class="variable language_">self</span>.buff_size)</span><br><span class="line">                <span class="keyword">if</span> buff <span class="keyword">and</span> sock_to_send.fileno() != -<span class="number">1</span>:</span><br><span class="line">                    sock_to_send.sendall(buff)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    sock_to_recv.close()</span><br><span class="line">                    sock_to_send.close()</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">except</span> (OSError, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> closed_socket_ex(ex):</span><br><span class="line">                Logger.error(<span class="string">&quot;fwd-socket: socket forwarding thread is exiting: %s&quot;</span> % ex)</span><br><span class="line">            sock_to_recv.close()</span><br><span class="line">            sock_to_send.close()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_socket_udp_recvfrom</span>(<span class="params">self</span>):</span><br><span class="line">        outbound_socks = &#123;&#125;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                buff, addr = <span class="variable language_">self</span>.sock.recvfrom(<span class="variable language_">self</span>.buff_size)</span><br><span class="line">                s = outbound_socks.get(addr)</span><br><span class="line">            <span class="keyword">except</span> (OSError, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> closed_socket_ex(ex):</span><br><span class="line">                    Logger.error(<span class="string">&quot;fwd-socket: socket recvfrom thread is exiting: %s&quot;</span> % ex)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> s:</span><br><span class="line">                    s = outbound_socks[addr] = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">                    s.settimeout(<span class="variable language_">self</span>.udp_timeout)</span><br><span class="line">                    s.connect(<span class="variable language_">self</span>.outbound_addr)</span><br><span class="line">                    <span class="keyword">if</span> threading.active_count() &gt;= <span class="variable language_">self</span>.max_threads:</span><br><span class="line">                        <span class="keyword">raise</span> OSError(<span class="string">&quot;Too many threads&quot;</span>)</span><br><span class="line">                    start_daemon_thread(<span class="variable language_">self</span>._socket_udp_send, args=(<span class="variable language_">self</span>.sock, s, addr))</span><br><span class="line">                <span class="keyword">if</span> buff:</span><br><span class="line">                    s.send(buff)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    s.close()</span><br><span class="line">                    <span class="keyword">del</span> outbound_socks[addr]</span><br><span class="line">            <span class="keyword">except</span> (OSError, socket.error):</span><br><span class="line">                <span class="keyword">if</span> addr <span class="keyword">in</span> outbound_socks:</span><br><span class="line">                    outbound_socks[addr].close()</span><br><span class="line">                    <span class="keyword">del</span> outbound_socks[addr]</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_socket_udp_send</span>(<span class="params">self, server_sock, outbound_sock, client_addr</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> outbound_sock.fileno() != -<span class="number">1</span>:</span><br><span class="line">                buff = outbound_sock.recv(<span class="variable language_">self</span>.buff_size)</span><br><span class="line">                <span class="keyword">if</span> buff:</span><br><span class="line">                    server_sock.sendto(buff, client_addr)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    outbound_sock.close()</span><br><span class="line">        <span class="keyword">except</span> (OSError, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> closed_socket_ex(ex):</span><br><span class="line">                Logger.error(<span class="string">&quot;fwd-socket: socket send thread is exiting: %s&quot;</span> % ex)</span><br><span class="line">            outbound_sock.close()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_forward</span>(<span class="params">self</span>):</span><br><span class="line">        Logger.debug(<span class="string">&quot;fwd-socket: Stopping socket&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.sock.close()</span><br><span class="line">        <span class="variable language_">self</span>.active = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UPnPService</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, device, bind_ip = <span class="literal">None</span>, interface = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.device             = device</span><br><span class="line">        <span class="variable language_">self</span>.service_type       = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.service_id         = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.scpd_url           = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.control_url        = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.eventsub_url       = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._sock_timeout      = <span class="number">3</span></span><br><span class="line">        <span class="variable language_">self</span>._bind_ip           = bind_ip</span><br><span class="line">        <span class="variable language_">self</span>._bind_interface    = interface</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;UPnPService service_type=%s, service_id=%s&gt;&quot;</span> % (</span><br><span class="line">            <span class="built_in">repr</span>(<span class="variable language_">self</span>.service_type), <span class="built_in">repr</span>(<span class="variable language_">self</span>.service_id)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_valid</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.service_type <span class="keyword">and</span> <span class="variable language_">self</span>.service_id <span class="keyword">and</span> <span class="variable language_">self</span>.control_url:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_forward</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.service_type <span class="keyword">in</span> (</span><br><span class="line">            <span class="string">&quot;urn:schemas-upnp-org:service:WANIPConnection:1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;urn:schemas-upnp-org:service:WANIPConnection:2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;urn:schemas-upnp-org:service:WANPPPConnection:1&quot;</span></span><br><span class="line">        ) <span class="keyword">and</span> <span class="variable language_">self</span>.service_id <span class="keyword">and</span> <span class="variable language_">self</span>.control_url:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward_port</span>(<span class="params">self, host, port, dest_host, dest_port, udp=<span class="literal">False</span>, duration=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.is_forward():</span><br><span class="line">            <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;Unsupported service type: %s&quot;</span> % <span class="variable language_">self</span>.service_type)</span><br><span class="line"></span><br><span class="line">        proto = <span class="string">&quot;UDP&quot;</span> <span class="keyword">if</span> udp <span class="keyword">else</span> <span class="string">&quot;TCP&quot;</span></span><br><span class="line">        ctl_hostname, ctl_port, ctl_path = split_url(<span class="variable language_">self</span>.control_url)</span><br><span class="line">        descpt = <span class="string">&quot;Natter&quot;</span></span><br><span class="line">        content = (</span><br><span class="line">            <span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;s:Envelope xmlns:s=\&quot;http://schemas.xmlsoap.org/soap/envelope/\&quot;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  s:encodingStyle=\&quot;http://schemas.xmlsoap.org/soap/encoding/\&quot;&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  &lt;s:Body&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    &lt;m:AddPortMapping xmlns:m=\&quot;%s\&quot;&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;      &lt;NewRemoteHost&gt;%s&lt;/NewRemoteHost&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;      &lt;NewExternalPort&gt;%s&lt;/NewExternalPort&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;      &lt;NewProtocol&gt;%s&lt;/NewProtocol&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;      &lt;NewInternalPort&gt;%s&lt;/NewInternalPort&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;      &lt;NewInternalClient&gt;%s&lt;/NewInternalClient&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;      &lt;NewEnabled&gt;1&lt;/NewEnabled&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;      &lt;NewPortMappingDescription&gt;%s&lt;/NewPortMappingDescription&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;      &lt;NewLeaseDuration&gt;%d&lt;/NewLeaseDuration&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    &lt;/m:AddPortMapping&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  &lt;/s:Body&gt;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/s:Envelope&gt;\r\n&quot;</span> % (</span><br><span class="line">                <span class="variable language_">self</span>.service_type, host, port, proto, dest_port, dest_host, descpt, duration</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        content_len = <span class="built_in">len</span>(content.encode())</span><br><span class="line">        data = (</span><br><span class="line">            <span class="string">&quot;POST %s HTTP/1.1\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Host: %s:%d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;User-Agent: curl/8.0.0 (Natter)\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Accept: */*\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;SOAPAction: \&quot;%s#AddPortMapping\&quot;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Content-Type: text/xml\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Content-Length: %d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;%s\r\n&quot;</span> % (ctl_path, ctl_hostname, ctl_port, <span class="variable language_">self</span>.service_type, content_len, content)</span><br><span class="line">        ).encode()</span><br><span class="line">        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        socket_set_opt(</span><br><span class="line">            sock,</span><br><span class="line">            bind_addr   = (<span class="variable language_">self</span>._bind_ip, <span class="number">0</span>) <span class="keyword">if</span> <span class="variable language_">self</span>._bind_ip <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            interface   = <span class="variable language_">self</span>._bind_interface,</span><br><span class="line">            timeout     = <span class="variable language_">self</span>._sock_timeout</span><br><span class="line">        )</span><br><span class="line">        sock.connect((ctl_hostname, ctl_port))</span><br><span class="line">        sock.sendall(data)</span><br><span class="line">        response = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            buff = sock.recv(<span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> buff:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            response += buff</span><br><span class="line">        sock.close()</span><br><span class="line">        r = response.decode(<span class="string">&quot;utf-8&quot;</span>, <span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">        errno = errmsg = <span class="string">&quot;&quot;</span></span><br><span class="line">        m = re.search(<span class="string">r&quot;&lt;errorCode\s*&gt;([^&lt;]*?)&lt;/errorCode\s*&gt;&quot;</span>, r)</span><br><span class="line">        <span class="keyword">if</span> m:</span><br><span class="line">            errno = m.group(<span class="number">1</span>).strip()</span><br><span class="line">        m = re.search(<span class="string">r&quot;&lt;errorDescription\s*&gt;([^&lt;]*?)&lt;/errorDescription\s*&gt;&quot;</span>, r)</span><br><span class="line">        <span class="keyword">if</span> m:</span><br><span class="line">            errmsg = m.group(<span class="number">1</span>).strip()</span><br><span class="line">        <span class="keyword">if</span> errno <span class="keyword">or</span> errmsg:</span><br><span class="line">            Logger.error(<span class="string">&quot;upnp: Error from service %s of device %s: [%s] %s&quot;</span> % (</span><br><span class="line">                <span class="variable language_">self</span>.service_type, <span class="variable language_">self</span>.device, errno, errmsg</span><br><span class="line">            ))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UPnPDevice</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ipaddr, xml_urls, bind_ip = <span class="literal">None</span>, interface = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.ipaddr = ipaddr</span><br><span class="line">        <span class="variable language_">self</span>.xml_urls = xml_urls</span><br><span class="line">        <span class="variable language_">self</span>.services = []</span><br><span class="line">        <span class="variable language_">self</span>.forward_srv = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._sock_timeout = <span class="number">3</span></span><br><span class="line">        <span class="variable language_">self</span>._bind_ip = bind_ip</span><br><span class="line">        <span class="variable language_">self</span>._bind_interface = interface</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;UPnPDevice ipaddr=%s&gt;&quot;</span> % (</span><br><span class="line">            <span class="built_in">repr</span>(<span class="variable language_">self</span>.ipaddr),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_services</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.services:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        services_d = &#123;&#125;     <span class="comment"># service_id =&gt; UPnPService()</span></span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> <span class="variable language_">self</span>.xml_urls:</span><br><span class="line">            sd = <span class="variable language_">self</span>._get_srv_dict(url)</span><br><span class="line">            services_d.update(sd)</span><br><span class="line">        <span class="variable language_">self</span>.services.extend(services_d.values())</span><br><span class="line">        <span class="keyword">for</span> srv <span class="keyword">in</span> <span class="variable language_">self</span>.services:</span><br><span class="line">            <span class="keyword">if</span> srv.is_forward():</span><br><span class="line">                <span class="variable language_">self</span>.forward_srv = srv</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_http_get</span>(<span class="params">self, url</span>):</span><br><span class="line">        hostname, port, path = split_url(url)</span><br><span class="line">        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        socket_set_opt(</span><br><span class="line">            sock,</span><br><span class="line">            bind_addr   = (<span class="variable language_">self</span>._bind_ip, <span class="number">0</span>) <span class="keyword">if</span> <span class="variable language_">self</span>._bind_ip <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            interface   = <span class="variable language_">self</span>._bind_interface,</span><br><span class="line">            timeout     = <span class="variable language_">self</span>._sock_timeout</span><br><span class="line">        )</span><br><span class="line">        sock.connect((hostname, port))</span><br><span class="line">        data = (</span><br><span class="line">            <span class="string">&quot;GET %s HTTP/1.1\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Host: %s\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;User-Agent: curl/8.0.0 (Natter)\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Accept: */*\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span> % (path, hostname)</span><br><span class="line">        ).encode()</span><br><span class="line">        sock.sendall(data)</span><br><span class="line">        response = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            buff = sock.recv(<span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> buff:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            response += buff</span><br><span class="line">        sock.close()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> response.startswith(<span class="string">b&quot;HTTP/&quot;</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid response from HTTP server&quot;</span>)</span><br><span class="line">        s = response.split(<span class="string">b&quot;\r\n\r\n&quot;</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(s) != <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid response from HTTP server&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> s[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_srv_dict</span>(<span class="params">self, url</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            xmlcontent = <span class="variable language_">self</span>._http_get(url).decode(<span class="string">&quot;utf-8&quot;</span>, <span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> (OSError, socket.error, ValueError) <span class="keyword">as</span> ex:</span><br><span class="line">            Logger.error(<span class="string">&quot;upnp: failed to load service from %s: %s&quot;</span> % (url, ex))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        services_d = &#123;&#125;</span><br><span class="line">        srv_str_l = re.findall(<span class="string">r&quot;&lt;service\s*&gt;([\s\S]+?)&lt;/service\s*&gt;&quot;</span>, xmlcontent)</span><br><span class="line">        <span class="keyword">for</span> srv_str <span class="keyword">in</span> srv_str_l:</span><br><span class="line">            srv = UPnPService(<span class="variable language_">self</span>, bind_ip=<span class="variable language_">self</span>._bind_ip, interface=<span class="variable language_">self</span>._bind_interface)</span><br><span class="line">            m = re.search(<span class="string">r&quot;&lt;serviceType\s*&gt;([^&lt;]*?)&lt;/serviceType\s*&gt;&quot;</span>, srv_str)</span><br><span class="line">            <span class="keyword">if</span> m:</span><br><span class="line">                srv.service_type    = m.group(<span class="number">1</span>).strip()</span><br><span class="line">            m = re.search(<span class="string">r&quot;&lt;serviceId\s*&gt;([^&lt;]*?)&lt;/serviceId\s*&gt;&quot;</span>, srv_str)</span><br><span class="line">            <span class="keyword">if</span> m:</span><br><span class="line">                srv.service_id      = m.group(<span class="number">1</span>).strip()</span><br><span class="line">            m = re.search(<span class="string">r&quot;&lt;SCPDURL\s*&gt;([^&lt;]*?)&lt;/SCPDURL\s*&gt;&quot;</span>, srv_str)</span><br><span class="line">            <span class="keyword">if</span> m:</span><br><span class="line">                srv.scpd_url        = full_url(m.group(<span class="number">1</span>).strip(), url)</span><br><span class="line">            m = re.search(<span class="string">r&quot;&lt;controlURL\s*&gt;([^&lt;]*?)&lt;/controlURL\s*&gt;&quot;</span>, srv_str)</span><br><span class="line">            <span class="keyword">if</span> m:</span><br><span class="line">                srv.control_url     = full_url(m.group(<span class="number">1</span>).strip(), url)</span><br><span class="line">            m = re.search(<span class="string">r&quot;&lt;eventSubURL\s*&gt;([^&lt;]*?)&lt;/eventSubURL\s*&gt;&quot;</span>, srv_str)</span><br><span class="line">            <span class="keyword">if</span> m:</span><br><span class="line">                srv.eventsub_url    = full_url(m.group(<span class="number">1</span>).strip(), url)</span><br><span class="line">            <span class="keyword">if</span> srv.is_valid():</span><br><span class="line">                services_d[srv.service_id] = srv</span><br><span class="line">        <span class="keyword">return</span> services_d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UPnPClient</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, bind_ip = <span class="literal">None</span>, interface = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.ssdp_addr          = (<span class="string">&quot;239.255.255.250&quot;</span>, <span class="number">1900</span>)</span><br><span class="line">        <span class="variable language_">self</span>.router             = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._sock_timeout      = <span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>._fwd_host          = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._fwd_port          = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._fwd_dest_host     = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._fwd_dest_port     = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._fwd_udp           = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>._fwd_duration      = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>._fwd_started       = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>._bind_ip           = bind_ip</span><br><span class="line">        <span class="variable language_">self</span>._bind_interface    = interface</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">discover_router</span>(<span class="params">self</span>):</span><br><span class="line">        router_l = []</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            devs = <span class="variable language_">self</span>._discover()</span><br><span class="line">            <span class="keyword">for</span> dev <span class="keyword">in</span> devs:</span><br><span class="line">                <span class="keyword">if</span> dev.forward_srv:</span><br><span class="line">                    router_l.append(dev)</span><br><span class="line">        <span class="keyword">except</span> (OSError, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">            Logger.error(<span class="string">&quot;upnp: failed to discover router: %s&quot;</span> % ex)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> router_l:</span><br><span class="line">            <span class="variable language_">self</span>.router = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(router_l) &gt; <span class="number">1</span>:</span><br><span class="line">            Logger.warning(<span class="string">&quot;upnp: multiple routers found: %s&quot;</span> % (router_l,))</span><br><span class="line">            <span class="variable language_">self</span>.router = router_l[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.router = router_l[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.router</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_discover</span>(<span class="params">self</span>):</span><br><span class="line">        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">        socket_set_opt(</span><br><span class="line">            sock,</span><br><span class="line">            reuse       = <span class="literal">True</span>,</span><br><span class="line">            bind_addr   = (<span class="variable language_">self</span>._bind_ip, <span class="number">0</span>) <span class="keyword">if</span> <span class="variable language_">self</span>._bind_ip <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            interface   = <span class="variable language_">self</span>._bind_interface,</span><br><span class="line">            timeout     = <span class="variable language_">self</span>._sock_timeout</span><br><span class="line">        )</span><br><span class="line">        dat01 = (</span><br><span class="line">            <span class="string">&quot;M-SEARCH * HTTP/1.1\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;ST: ssdp:all\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;MX: 2\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;MAN: \&quot;ssdp:discover\&quot;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;HOST: %s:%d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span> % <span class="variable language_">self</span>.ssdp_addr</span><br><span class="line">        ).encode()</span><br><span class="line"></span><br><span class="line">        dat02 = (</span><br><span class="line">            <span class="string">&quot;M-SEARCH * HTTP/1.1\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;ST: upnp:rootdevice\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;MX: 2\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;MAN: \&quot;ssdp:discover\&quot;\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;HOST: %s:%d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span> % <span class="variable language_">self</span>.ssdp_addr</span><br><span class="line">        ).encode()</span><br><span class="line"></span><br><span class="line">        sock.sendto(dat01, <span class="variable language_">self</span>.ssdp_addr)</span><br><span class="line">        sock.sendto(dat02, <span class="variable language_">self</span>.ssdp_addr)</span><br><span class="line"></span><br><span class="line">        upnp_urls_d = &#123;&#125;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                buff, addr = sock.recvfrom(<span class="number">4096</span>)</span><br><span class="line">                m = re.search(<span class="string">r&quot;LOCATION: *(/302.html?target=http://[^\[]\S+)\s+&quot;</span>, buff.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> m:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                ipaddr = addr[<span class="number">0</span>]</span><br><span class="line">                location = m.group(<span class="number">1</span>)</span><br><span class="line">                Logger.debug(<span class="string">&quot;upnp: Got URL %s&quot;</span> % location)</span><br><span class="line">                <span class="keyword">if</span> ipaddr <span class="keyword">in</span> upnp_urls_d:</span><br><span class="line">                    upnp_urls_d[ipaddr].add(location)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    upnp_urls_d[ipaddr] = <span class="built_in">set</span>([location])</span><br><span class="line">            <span class="keyword">except</span> socket.timeout:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        devs = []</span><br><span class="line">        <span class="keyword">for</span> ipaddr, urls <span class="keyword">in</span> upnp_urls_d.items():</span><br><span class="line">            d = UPnPDevice(ipaddr, urls, bind_ip=<span class="variable language_">self</span>._bind_ip, interface=<span class="variable language_">self</span>._bind_interface)</span><br><span class="line">            d._load_services()</span><br><span class="line">            devs.append(d)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> devs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, host, port, dest_host, dest_port, udp=<span class="literal">False</span>, duration=<span class="number">0</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.router:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;No router is available&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.router.forward_srv.forward_port(host, port, dest_host, dest_port, udp, duration)</span><br><span class="line">        <span class="variable language_">self</span>._fwd_host      = host</span><br><span class="line">        <span class="variable language_">self</span>._fwd_port      = port</span><br><span class="line">        <span class="variable language_">self</span>._fwd_dest_host = dest_host</span><br><span class="line">        <span class="variable language_">self</span>._fwd_dest_port = dest_port</span><br><span class="line">        <span class="variable language_">self</span>._fwd_udp       = udp</span><br><span class="line">        <span class="variable language_">self</span>._fwd_duration  = duration</span><br><span class="line">        <span class="variable language_">self</span>._fwd_started   = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">renew</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._fwd_started:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;UPnP forward not started&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.router.forward_srv.forward_port(</span><br><span class="line">            <span class="variable language_">self</span>._fwd_host, <span class="variable language_">self</span>._fwd_port, <span class="variable language_">self</span>._fwd_dest_host,</span><br><span class="line">            <span class="variable language_">self</span>._fwd_dest_port, <span class="variable language_">self</span>._fwd_udp, <span class="variable language_">self</span>._fwd_duration</span><br><span class="line">        )</span><br><span class="line">        Logger.debug(<span class="string">&quot;upnp: OK&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NatterExitException</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NatterRetryException</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">socket_set_opt</span>(<span class="params">sock, reuse=<span class="literal">False</span>, bind_addr=<span class="literal">None</span>, interface=<span class="literal">None</span>, timeout=-<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">if</span> reuse:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(socket, <span class="string">&quot;SO_REUSEADDR&quot;</span>):</span><br><span class="line">            sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(socket, <span class="string">&quot;SO_REUSEPORT&quot;</span>):</span><br><span class="line">            sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEPORT, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> interface <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(socket, <span class="string">&quot;SO_BINDTODEVICE&quot;</span>):</span><br><span class="line">            sock.setsockopt(</span><br><span class="line">                socket.SOL_SOCKET, socket.SO_BINDTODEVICE, interface.encode() + <span class="string">b&quot;\0&quot;</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Binding to an interface is not supported on your platform.&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> bind_addr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        sock.bind(bind_addr)</span><br><span class="line">    <span class="keyword">if</span> timeout != -<span class="number">1</span>:</span><br><span class="line">        sock.settimeout(timeout)</span><br><span class="line">    <span class="keyword">return</span> sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_daemon_thread</span>(<span class="params">target, args=(<span class="params"></span>)</span>):</span><br><span class="line">    th = threading.Thread(target=target, args=args)</span><br><span class="line">    th.daemon = <span class="literal">True</span></span><br><span class="line">    th.start()</span><br><span class="line">    <span class="keyword">return</span> th</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">closed_socket_ex</span>(<span class="params">ex</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(ex, <span class="string">&quot;errno&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(errno, <span class="string">&quot;ECONNABORTED&quot;</span>) <span class="keyword">and</span> ex.errno == errno.ECONNABORTED:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(errno, <span class="string">&quot;EBADFD&quot;</span>) <span class="keyword">and</span> ex.errno == errno.EBADFD:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(errno, <span class="string">&quot;EBADF&quot;</span>) <span class="keyword">and</span> ex.errno == errno.EBADF:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(errno, <span class="string">&quot;WSAEBADF&quot;</span>) <span class="keyword">and</span> ex.errno == errno.WSAEBADF:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(errno, <span class="string">&quot;WSAEINTR&quot;</span>) <span class="keyword">and</span> ex.errno == errno.WSAEINTR:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fix_codecs</span>(<span class="params">codec_list = [<span class="string">&quot;utf-8&quot;</span>, <span class="string">&quot;idna&quot;</span>]</span>):</span><br><span class="line">    missing_codecs = []</span><br><span class="line">    <span class="keyword">for</span> codec_name <span class="keyword">in</span> codec_list:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            codecs.lookup(codec_name)</span><br><span class="line">        <span class="keyword">except</span> LookupError:</span><br><span class="line">            missing_codecs.append(codec_name.lower())</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_codec</span>(<span class="params">name</span>):</span><br><span class="line">        <span class="keyword">if</span> name.lower() <span class="keyword">in</span> missing_codecs:</span><br><span class="line">            <span class="keyword">return</span> codecs.CodecInfo(codecs.ascii_encode, codecs.ascii_decode, name=<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> missing_codecs:</span><br><span class="line">        codecs.register(search_codec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_docker_network</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> sys.platform.startswith(<span class="string">&quot;linux&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&quot;/.dockerenv&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(<span class="string">&quot;/sys/class/net/eth0/address&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    fo = <span class="built_in">open</span>(<span class="string">&quot;/sys/class/net/eth0/address&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">    macaddr = fo.read().strip()</span><br><span class="line">    fo.close()</span><br><span class="line">    hostname = socket.gethostname()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ipaddr = socket.gethostbyname(hostname)</span><br><span class="line">    <span class="keyword">except</span> socket.gaierror:</span><br><span class="line">        Logger.warning(<span class="string">&quot;check-docket-network: Cannot resolve hostname `%s`&quot;</span> % hostname)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    docker_macaddr = <span class="string">&quot;02:42:&quot;</span> + <span class="string">&quot;:&quot;</span>.join([<span class="string">&quot;%02x&quot;</span> % <span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> ipaddr.split(<span class="string">&quot;.&quot;</span>)])</span><br><span class="line">    <span class="keyword">if</span> macaddr == docker_macaddr:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Docker&#x27;s `--net=host` option is required.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(<span class="string">&quot;/proc/sys/kernel/osrelease&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    fo = <span class="built_in">open</span>(<span class="string">&quot;/proc/sys/kernel/osrelease&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">    uname_r = fo.read().strip()</span><br><span class="line">    fo.close()</span><br><span class="line">    uname_r_sfx = uname_r.rsplit(<span class="string">&quot;-&quot;</span>).pop()</span><br><span class="line">    <span class="keyword">if</span> uname_r_sfx.lower() <span class="keyword">in</span> [<span class="string">&quot;linuxkit&quot;</span>, <span class="string">&quot;wsl2&quot;</span>] <span class="keyword">and</span> hostname.lower() == <span class="string">&quot;docker-desktop&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Network from Docker Desktop is not supported.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_url</span>(<span class="params">url</span>):</span><br><span class="line">    m = re.<span class="keyword">match</span>(</span><br><span class="line">        <span class="string">r&quot;^http://([^\[\]:/]+)(?:\:([0-9]+))?(/\S*)?$&quot;</span>, url</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> m:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Unsupported URL: %s&quot;</span> % url)</span><br><span class="line">    hostname, port_str, path = m.groups()</span><br><span class="line">    port = <span class="number">80</span></span><br><span class="line">    <span class="keyword">if</span> port_str:</span><br><span class="line">        port = <span class="built_in">int</span>(port_str)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> path:</span><br><span class="line">        path = <span class="string">&quot;/&quot;</span></span><br><span class="line">    <span class="keyword">return</span> hostname, port, path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">full_url</span>(<span class="params">u, refurl</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> u.startswith(<span class="string">&quot;/&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> u</span><br><span class="line">    hostname, port, _ = split_url(refurl)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;http://%s:%d&quot;</span> % (hostname, port) + u</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">addr_to_str</span>(<span class="params">addr</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;%s:%d&quot;</span> % addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">addr_to_uri</span>(<span class="params">addr, udp=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> udp:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;udp://%s:%d&quot;</span> % addr</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;tcp://%s:%d&quot;</span> % addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_ip</span>(<span class="params">s, err=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        socket.inet_aton(s)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> (OSError, socket.error):</span><br><span class="line">        <span class="keyword">if</span> err:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid IP address: %s&quot;</span> % s)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_port</span>(<span class="params">s, err=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">str</span>(s).isdigit() <span class="keyword">and</span> <span class="built_in">int</span>(s) <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">65536</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> err:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid port number: %s&quot;</span> % s)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_addr_str</span>(<span class="params">s, err=<span class="literal">True</span></span>):</span><br><span class="line">    l = <span class="built_in">str</span>(s).split(<span class="string">&quot;:&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(l) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> validate_port(l[<span class="number">1</span>], err)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_positive</span>(<span class="params">s, err=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">str</span>(s).isdigit() <span class="keyword">and</span> <span class="built_in">int</span>(s) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> err:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Not a positive integer: %s&quot;</span> % s)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_filepath</span>(<span class="params">s, err=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(s):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> err:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;File not found: %s&quot;</span> % s)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ip_normalize</span>(<span class="params">ipaddr</span>):</span><br><span class="line">    <span class="keyword">return</span> socket.inet_ntoa(socket.inet_aton(ipaddr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">natter_main</span>(<span class="params">show_title = <span class="literal">True</span></span>):</span><br><span class="line">    argp = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&quot;Expose your port behind full-cone NAT to the Internet.&quot;</span>, add_help=<span class="literal">False</span></span><br><span class="line">    )</span><br><span class="line">    group = argp.add_argument_group(<span class="string">&quot;options&quot;</span>)</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;--version&quot;</span>, <span class="string">&quot;-V&quot;</span>, action=<span class="string">&quot;version&quot;</span>, version=<span class="string">&quot;Natter %s&quot;</span> % __version__,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;show the version of Natter and exit&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;--help&quot;</span>, action=<span class="string">&quot;help&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;show this help message and exit&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-v&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;verbose mode, printing debug messages&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-q&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;exit when mapped address is changed&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-u&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;UDP mode&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-U&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;enable UPnP/IGD discovery&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-k&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, metavar=<span class="string">&quot;&lt;interval&gt;&quot;</span>, default=<span class="number">15</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;seconds between each keep-alive&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-s&quot;</span>, metavar=<span class="string">&quot;&lt;address&gt;&quot;</span>, action=<span class="string">&quot;append&quot;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;hostname or address to STUN server&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-h&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, metavar=<span class="string">&quot;&lt;address&gt;&quot;</span>, default=<span class="literal">None</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;hostname or address to keep-alive server&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-e&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, metavar=<span class="string">&quot;&lt;path&gt;&quot;</span>, default=<span class="literal">None</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;script path for notifying mapped address&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group = argp.add_argument_group(<span class="string">&quot;bind options&quot;</span>)</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-i&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, metavar=<span class="string">&quot;&lt;interface&gt;&quot;</span>, default=<span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;network interface name or IP to bind&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-b&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, metavar=<span class="string">&quot;&lt;port&gt;&quot;</span>, default=<span class="number">0</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;port number to bind&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group = argp.add_argument_group(<span class="string">&quot;forward options&quot;</span>)</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-m&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, metavar=<span class="string">&quot;&lt;method&gt;&quot;</span>, default=<span class="literal">None</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;forward method, common values are &#x27;iptables&#x27;, &#x27;nftables&#x27;, &quot;</span></span><br><span class="line">             <span class="string">&quot;&#x27;socat&#x27;, &#x27;gost&#x27; and &#x27;socket&#x27;&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-t&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, metavar=<span class="string">&quot;&lt;address&gt;&quot;</span>, default=<span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;IP address of forward target&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-p&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, metavar=<span class="string">&quot;&lt;port&gt;&quot;</span>, default=<span class="number">0</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;port number of forward target&quot;</span></span><br><span class="line">    )</span><br><span class="line">    group.add_argument(</span><br><span class="line">        <span class="string">&quot;-r&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;keep retrying until the port of forward target is open&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    args = argp.parse_args()</span><br><span class="line">    verbose = args.v</span><br><span class="line">    udp_mode = args.u</span><br><span class="line">    upnp_enabled = args.U</span><br><span class="line">    interval = args.k</span><br><span class="line">    stun_list = args.s</span><br><span class="line">    keepalive_srv = args.h</span><br><span class="line">    notify_sh = args.e</span><br><span class="line">    bind_ip = args.i</span><br><span class="line">    bind_interface = <span class="literal">None</span></span><br><span class="line">    bind_port = args.b</span><br><span class="line">    method = args.m</span><br><span class="line">    to_ip = args.t</span><br><span class="line">    to_port = args.p</span><br><span class="line">    keep_retry = args.r</span><br><span class="line">    exit_when_changed = args.q</span><br><span class="line"></span><br><span class="line">    sys.tracebacklimit = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> verbose:</span><br><span class="line">        sys.tracebacklimit = <span class="literal">None</span></span><br><span class="line">        Logger.set_level(Logger.DEBUG)</span><br><span class="line"></span><br><span class="line">    validate_positive(interval)</span><br><span class="line">    <span class="keyword">if</span> stun_list:</span><br><span class="line">        <span class="keyword">for</span> stun_srv <span class="keyword">in</span> stun_list:</span><br><span class="line">            validate_addr_str(stun_srv)</span><br><span class="line">    validate_addr_str(keepalive_srv)</span><br><span class="line">    <span class="keyword">if</span> notify_sh:</span><br><span class="line">        validate_filepath(notify_sh)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> validate_ip(bind_ip, err=<span class="literal">False</span>):</span><br><span class="line">        bind_interface = bind_ip</span><br><span class="line">        bind_ip = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    validate_port(bind_port)</span><br><span class="line">    validate_ip(to_ip)</span><br><span class="line">    validate_port(to_port)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Normalize IPv4 in dotted-decimal notation</span></span><br><span class="line">    <span class="comment">#   e.g. 10.1 -&gt; 10.0.0.1</span></span><br><span class="line">    bind_ip = ip_normalize(bind_ip)</span><br><span class="line">    to_ip = ip_normalize(to_ip)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> stun_list:</span><br><span class="line">        stun_list = [</span><br><span class="line">            <span class="string">&quot;fwa.lifesizecloud.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;global.turn.twilio.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;turn.cloudflare.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;stun.isp.net.au&quot;</span>,</span><br><span class="line">            <span class="string">&quot;stun.nextcloud.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;stun.freeswitch.org&quot;</span>,</span><br><span class="line">            <span class="string">&quot;stun.voip.blackberry.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;stunserver.stunprotocol.org&quot;</span>,</span><br><span class="line">            <span class="string">&quot;stun.sipnet.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;stun.radiojar.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;stun.sonetel.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;stun.telnyx.com&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> udp_mode:</span><br><span class="line">            stun_list = stun_list + [</span><br><span class="line">                <span class="string">&quot;turn.cloud-rtc.com:80&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            stun_list = [</span><br><span class="line">                <span class="string">&quot;stun.miwifi.com&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stun.chat.bilibili.com&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stun.hitv.com&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stun.cdnbye.com&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stun.douyucdn.cn:18000&quot;</span></span><br><span class="line">            ] + stun_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> keepalive_srv:</span><br><span class="line">        keepalive_srv = <span class="string">&quot;www.baidu.com&quot;</span></span><br><span class="line">        <span class="keyword">if</span> udp_mode:</span><br><span class="line">            keepalive_srv = <span class="string">&quot;119.29.29.29&quot;</span></span><br><span class="line"></span><br><span class="line">    stun_srv_list = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> stun_list:</span><br><span class="line">        l = item.split(<span class="string">&quot;:&quot;</span>, <span class="number">2</span>) + [<span class="string">&quot;3478&quot;</span>]</span><br><span class="line">        stun_srv_list.append((l[<span class="number">0</span>], <span class="built_in">int</span>(l[<span class="number">1</span>])),)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> udp_mode:</span><br><span class="line">        l = keepalive_srv.split(<span class="string">&quot;:&quot;</span>, <span class="number">2</span>) + [<span class="string">&quot;53&quot;</span>]</span><br><span class="line">        keepalive_host, keepalive_port = l[<span class="number">0</span>], <span class="built_in">int</span>(l[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        l = keepalive_srv.split(<span class="string">&quot;:&quot;</span>, <span class="number">2</span>) + [<span class="string">&quot;80&quot;</span>]</span><br><span class="line">        keepalive_host, keepalive_port = l[<span class="number">0</span>], <span class="built_in">int</span>(l[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward method defaults</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> method:</span><br><span class="line">        <span class="keyword">if</span> to_ip == <span class="string">&quot;0.0.0.0&quot;</span> <span class="keyword">and</span> to_port == <span class="number">0</span> <span class="keyword">and</span> \</span><br><span class="line">                bind_ip == <span class="string">&quot;0.0.0.0&quot;</span> <span class="keyword">and</span> bind_port == <span class="number">0</span> <span class="keyword">and</span> bind_interface <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            method = <span class="string">&quot;test&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> to_ip == <span class="string">&quot;0.0.0.0&quot;</span> <span class="keyword">and</span> to_port == <span class="number">0</span>:</span><br><span class="line">            method = <span class="string">&quot;none&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            method = <span class="string">&quot;socket&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> method == <span class="string">&quot;none&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardNone</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;test&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardTestServer</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;iptables&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardIptables</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;sudo-iptables&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardSudoIptables</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;iptables-snat&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardIptablesSnat</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;sudo-iptables-snat&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardSudoIptablesSnat</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;nftables&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardNftables</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;sudo-nftables&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardSudoNftables</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;nftables-snat&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardNftablesSnat</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;sudo-nftables-snat&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardSudoNftablesSnat</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;socat&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardSocat</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;gost&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardGost</span><br><span class="line">    <span class="keyword">elif</span> method == <span class="string">&quot;socket&quot;</span>:</span><br><span class="line">        ForwardImpl = ForwardSocket</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Unknown method name: %s&quot;</span> % method)</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#  Natter</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="keyword">if</span> show_title:</span><br><span class="line">        Logger.info(<span class="string">&quot;Natter v%s&quot;</span> % __version__)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">1</span>:</span><br><span class="line">            Logger.info(<span class="string">&quot;Tips: Use `--help` to see help messages&quot;</span>)</span><br><span class="line"></span><br><span class="line">    check_docker_network()</span><br><span class="line"></span><br><span class="line">    forwarder = ForwardImpl()</span><br><span class="line">    port_test = PortTest()</span><br><span class="line"></span><br><span class="line">    stun = StunClient(stun_srv_list, bind_ip, bind_port, udp=udp_mode, interface=bind_interface)</span><br><span class="line">    natter_addr, outer_addr = stun.get_mapping()</span><br><span class="line">    <span class="comment"># set actual ip and port for keep-alive socket to bind, instead of zero</span></span><br><span class="line">    bind_ip, bind_port = natter_addr</span><br><span class="line"></span><br><span class="line">    keep_alive = KeepAlive(keepalive_host, keepalive_port, bind_ip, bind_port, udp=udp_mode, interface=bind_interface)</span><br><span class="line">    keep_alive.keep_alive()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the mapped address again after the keep-alive connection is established</span></span><br><span class="line">    outer_addr_prev = outer_addr</span><br><span class="line">    natter_addr, outer_addr = stun.get_mapping()</span><br><span class="line">    <span class="keyword">if</span> outer_addr != outer_addr_prev:</span><br><span class="line">        Logger.warning(<span class="string">&quot;Network is unstable, or not full cone&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set actual ip of localhost for correct forwarding</span></span><br><span class="line">    <span class="keyword">if</span> socket.inet_aton(to_ip) <span class="keyword">in</span> [socket.inet_aton(<span class="string">&quot;127.0.0.1&quot;</span>), socket.inet_aton(<span class="string">&quot;0.0.0.0&quot;</span>)]:</span><br><span class="line">        to_ip = natter_addr[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if not specified, the target port is set to be the same as the outer port</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> to_port:</span><br><span class="line">        to_port = outer_addr[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># some exceptions: ForwardNone and ForwardTestServer are not real forward methods,</span></span><br><span class="line">    <span class="comment"># so let target ip and port equal to natter&#x27;s</span></span><br><span class="line">    <span class="keyword">if</span> ForwardImpl <span class="keyword">in</span> (ForwardNone, ForwardTestServer):</span><br><span class="line">        to_ip, to_port = natter_addr</span><br><span class="line"></span><br><span class="line">    to_addr = (to_ip, to_port)</span><br><span class="line">    forwarder.start_forward(natter_addr[<span class="number">0</span>], natter_addr[<span class="number">1</span>], to_addr[<span class="number">0</span>], to_addr[<span class="number">1</span>], udp=udp_mode)</span><br><span class="line">    NatterExit.set_atexit(forwarder.stop_forward)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># UPnP</span></span><br><span class="line">    upnp = <span class="literal">None</span></span><br><span class="line">    upnp_router = <span class="literal">None</span></span><br><span class="line">    upnp_ready = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> upnp_enabled:</span><br><span class="line">        upnp = UPnPClient(bind_ip=natter_addr[<span class="number">0</span>], interface=bind_interface)</span><br><span class="line">        Logger.info()</span><br><span class="line">        Logger.info(<span class="string">&quot;Scanning UPnP Devices...&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            upnp_router = upnp.discover_router()</span><br><span class="line">        <span class="keyword">except</span> (OSError, socket.error, ValueError) <span class="keyword">as</span> ex:</span><br><span class="line">            Logger.error(<span class="string">&quot;upnp: failed to discover router: %s&quot;</span> % ex)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> upnp_router:</span><br><span class="line">        Logger.info(<span class="string">&quot;[UPnP] Found router %s&quot;</span> % upnp_router.ipaddr)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            upnp.forward(<span class="string">&quot;&quot;</span>, bind_port, bind_ip, bind_port, udp=udp_mode, duration=interval*<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">except</span> (OSError, socket.error, ValueError) <span class="keyword">as</span> ex:</span><br><span class="line">            Logger.error(<span class="string">&quot;upnp: failed to forward port: %s&quot;</span> % ex)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            upnp_ready = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Display route information</span></span><br><span class="line">    Logger.info()</span><br><span class="line">    route_str = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> ForwardImpl <span class="keyword">not</span> <span class="keyword">in</span> (ForwardNone, ForwardTestServer):</span><br><span class="line">        route_str += <span class="string">&quot;%s &lt;--%s--&gt; &quot;</span> % (addr_to_uri(to_addr, udp=udp_mode), method)</span><br><span class="line">    route_str += <span class="string">&quot;%s &lt;--Natter--&gt; %s&quot;</span> % (</span><br><span class="line">        addr_to_uri(natter_addr, udp=udp_mode), addr_to_uri(outer_addr, udp=udp_mode)</span><br><span class="line">    )</span><br><span class="line">    Logger.info(route_str)</span><br><span class="line">    Logger.info()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Test mode notice</span></span><br><span class="line">    <span class="keyword">if</span> ForwardImpl == ForwardTestServer:</span><br><span class="line">        Logger.info(<span class="string">&quot;Test mode in on.&quot;</span>)</span><br><span class="line">        Logger.info(<span class="string">&quot;Please check [ %s://%s ]&quot;</span> % (<span class="string">&quot;udp&quot;</span> <span class="keyword">if</span> udp_mode <span class="keyword">else</span> <span class="string">&quot;http&quot;</span>, addr_to_str(outer_addr)))</span><br><span class="line">        Logger.info()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Call notification script</span></span><br><span class="line">    <span class="keyword">if</span> notify_sh:</span><br><span class="line">        protocol = <span class="string">&quot;udp&quot;</span> <span class="keyword">if</span> udp_mode <span class="keyword">else</span> <span class="string">&quot;tcp&quot;</span></span><br><span class="line">        inner_ip, inner_port = to_addr <span class="keyword">if</span> method <span class="keyword">else</span> natter_addr</span><br><span class="line">        outer_ip, outer_port = outer_addr</span><br><span class="line">        Logger.info(<span class="string">&quot;Calling script: %s&quot;</span> % notify_sh)</span><br><span class="line">        subprocess.call([</span><br><span class="line">            os.path.abspath(notify_sh), protocol, <span class="built_in">str</span>(inner_ip), <span class="built_in">str</span>(inner_port), <span class="built_in">str</span>(outer_ip), <span class="built_in">str</span>(outer_port)</span><br><span class="line">        ], shell=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Display check results, TCP only</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> udp_mode:</span><br><span class="line">        ret1 = port_test.test_lan(to_addr, info=<span class="literal">True</span>)</span><br><span class="line">        ret2 = port_test.test_lan(natter_addr, info=<span class="literal">True</span>)</span><br><span class="line">        ret3 = port_test.test_lan(outer_addr, source_ip=natter_addr[<span class="number">0</span>], interface=bind_interface, info=<span class="literal">True</span>)</span><br><span class="line">        ret4 = port_test.test_wan(outer_addr, source_ip=natter_addr[<span class="number">0</span>], interface=bind_interface, info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> ret1 == -<span class="number">1</span>:</span><br><span class="line">            Logger.warning(<span class="string">&quot;!! Target port is closed !!&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> ret1 == <span class="number">1</span> <span class="keyword">and</span> ret3 == ret4 == -<span class="number">1</span>:</span><br><span class="line">            Logger.warning(<span class="string">&quot;!! Hole punching failed !!&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> ret3 == <span class="number">1</span> <span class="keyword">and</span> ret4 == -<span class="number">1</span>:</span><br><span class="line">            Logger.warning(<span class="string">&quot;!! You may be behind a firewall !!&quot;</span>)</span><br><span class="line">        Logger.info()</span><br><span class="line">        <span class="comment"># retry</span></span><br><span class="line">        <span class="keyword">if</span> keep_retry <span class="keyword">and</span> ret1 == -<span class="number">1</span>:</span><br><span class="line">            Logger.info(<span class="string">&quot;Retry after %d seconds...&quot;</span> % interval)</span><br><span class="line">            time.sleep(interval)</span><br><span class="line">            forwarder.stop_forward()</span><br><span class="line">            <span class="keyword">raise</span> NatterRetryException(<span class="string">&quot;Target port is closed&quot;</span>)</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#  Main loop</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    need_recheck = <span class="literal">False</span></span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># force recheck every 20th loop</span></span><br><span class="line">        cnt = (cnt + <span class="number">1</span>) % <span class="number">20</span></span><br><span class="line">        <span class="keyword">if</span> cnt == <span class="number">0</span>:</span><br><span class="line">            need_recheck = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> need_recheck:</span><br><span class="line">            Logger.debug(<span class="string">&quot;Start recheck&quot;</span>)</span><br><span class="line">            need_recheck = <span class="literal">False</span></span><br><span class="line">            <span class="comment"># check LAN port first</span></span><br><span class="line">            <span class="keyword">if</span> udp_mode <span class="keyword">or</span> port_test.test_lan(outer_addr, source_ip=natter_addr[<span class="number">0</span>], interface=bind_interface) == -<span class="number">1</span>:</span><br><span class="line">                <span class="comment"># then check through STUN</span></span><br><span class="line">                _, outer_addr_curr = stun.get_mapping()</span><br><span class="line">                <span class="keyword">if</span> outer_addr_curr != outer_addr:</span><br><span class="line">                    forwarder.stop_forward()</span><br><span class="line">                    <span class="comment"># exit or retry</span></span><br><span class="line">                    <span class="keyword">if</span> exit_when_changed:</span><br><span class="line">                        Logger.info(<span class="string">&quot;Natter is exiting because mapped address has changed&quot;</span>)</span><br><span class="line">                        <span class="keyword">raise</span> NatterExitException(<span class="string">&quot;Mapped address has changed&quot;</span>)</span><br><span class="line">                    <span class="keyword">raise</span> NatterRetryException(<span class="string">&quot;Mapped address has changed&quot;</span>)</span><br><span class="line">        <span class="comment"># end of recheck</span></span><br><span class="line">        ts = time.time()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            keep_alive.keep_alive()</span><br><span class="line">        <span class="keyword">except</span> (OSError, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">            <span class="keyword">if</span> udp_mode:</span><br><span class="line">                Logger.debug(<span class="string">&quot;keep-alive: UDP response not received: %s&quot;</span> % ex)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                Logger.error(<span class="string">&quot;keep-alive: connection broken: %s&quot;</span> % ex)</span><br><span class="line">            keep_alive.reset()</span><br><span class="line">            need_recheck = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> upnp_ready:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                upnp.renew()</span><br><span class="line">            <span class="keyword">except</span> (OSError, socket.error) <span class="keyword">as</span> ex:</span><br><span class="line">                Logger.error(<span class="string">&quot;upnp: failed to renew upnp: %s&quot;</span> % ex)</span><br><span class="line">        sleep_sec = interval - (time.time() - ts)</span><br><span class="line">        <span class="keyword">if</span> sleep_sec &gt; <span class="number">0</span>:</span><br><span class="line">            time.sleep(sleep_sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    signal.signal(signal.SIGTERM, <span class="keyword">lambda</span> s,f:exit(<span class="number">143</span>))</span><br><span class="line">    fix_codecs()</span><br><span class="line">    show_title = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            natter_main(show_title)</span><br><span class="line">        <span class="keyword">except</span> NatterRetryException:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">except</span> (NatterExitException, KeyboardInterrupt):</span><br><span class="line">            sys.exit()</span><br><span class="line">        show_title = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="NATæ£€æµ‹"><a href="#NATæ£€æµ‹" class="headerlink" title="NATæ£€æµ‹"></a>NATæ£€æµ‹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 natter.py --check-nat</span><br></pre></td></tr></table></figure>

<ul>
<li>NAT4</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[INFO] - Getting STUN server IP...</span><br><span class="line">[INFO] - NAT Type for UDP: [ Port restricted (NAT 3) ]</span><br><span class="line">[WARNING] - The NAT type of your network is not full cone (NAT 1). TCP hole punching may fail.</span><br><span class="line">[INFO] - Checking NAT Type for TCP...</span><br><span class="line">[INFO] - NAT Type for TCP: [ Cone NAT ]</span><br></pre></td></tr></table></figure>

<ul>
<li>NAT1</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[INFO] - Getting STUN server IP...</span><br><span class="line">[INFO] - NAT Type for UDP: [ Full cone (NAT 1) ]</span><br><span class="line">[INFO] - Checking NAT Type for TCP...</span><br><span class="line">[INFO] - NAT Type for TCP: [ Cone NAT ]</span><br></pre></td></tr></table></figure>

<h2 id="å®Œæˆ"><a href="#å®Œæˆ" class="headerlink" title="å®Œæˆ"></a>å®Œæˆ</h2><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><p><a target="_blank" rel="noopener" href="https://blog.xioxix.com/archives/277">Timoåœ¨æ­¤çš„åšå®¢â€”â€”leaf</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div><svg class="coin" width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.045 25.5454C7.69377 25.5454 2.54504 20.3967 2.54504 14.0454C2.54504 7.69413 7.69377 2.54541 14.045 2.54541C20.3963 2.54541 25.545 7.69413 25.545 14.0454C25.545 17.0954 24.3334 20.0205 22.1768 22.1771C20.0201 24.3338 17.095 25.5454 14.045 25.5454ZM9.66202 6.81624H18.2761C18.825 6.81624 19.27 7.22183 19.27 7.72216C19.27 8.22248 18.825 8.62807 18.2761 8.62807H14.95V10.2903C17.989 10.4444 20.3766 12.9487 20.3855 15.9916V17.1995C20.3854 17.6997 19.9799 18.1052 19.4796 18.1052C18.9793 18.1052 18.5738 17.6997 18.5737 17.1995V15.9916C18.5667 13.9478 16.9882 12.2535 14.95 12.1022V20.5574C14.95 21.0577 14.5444 21.4633 14.0441 21.4633C13.5437 21.4633 13.1382 21.0577 13.1382 20.5574V12.1022C11.1 12.2535 9.52148 13.9478 9.51448 15.9916V17.1995C9.5144 17.6997 9.10883 18.1052 8.60856 18.1052C8.1083 18.1052 7.70273 17.6997 7.70265 17.1995V15.9916C7.71158 12.9487 10.0992 10.4444 13.1382 10.2903V8.62807H9.66202C9.11309 8.62807 8.66809 8.22248 8.66809 7.72216C8.66809 7.22183 9.11309 6.81624 9.66202 6.81624Z" fill="currentColor"></path></svg></div>
  <button>
    å‚¨é’±ç½
  </button>
  <div class="post-reward">
      <div>
        <img src="/assets/images/reward/images/wxpay.png" alt="57uv6Z6g å¾®ä¿¡æ”¯ä»˜">
        <span>å¾®ä¿¡æ”¯ä»˜</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/alipay.png" alt="57uv6Z6g æ”¯ä»˜å®">
        <span>æ”¯ä»˜å®</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/qqpay.png" alt="57uv6Z6g qqpay">
        <span>qqpay</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/bitcoin.png" alt="57uv6Z6g æ¯”ç‰¹å¸">
        <span>æ¯”ç‰¹å¸</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/ethereum.png" alt="57uv6Z6g ethereum">
        <span>ethereum</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/monero.png" alt="57uv6Z6g monero">
        <span>monero</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/paypal.png" alt="57uv6Z6g è´å®">
        <span>è´å®</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Github/" rel="tag"># Github</a>
              <a href="/tags/Python/" rel="tag"># Python</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/14/MacOS%E9%87%8D%E5%90%AFTouchBar%E8%A7%A6%E6%8E%A7%E6%A0%8F/" rel="prev" title="ã€ç¬”è®°ã€‘MacOSé‡å¯TouchBarè§¦æ§æ ">
                  <i class="fa fa-angle-left"></i> ã€ç¬”è®°ã€‘MacOSé‡å¯TouchBarè§¦æ§æ 
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/15/JS%E7%9A%84Promise%E6%89%BF%E8%AF%BA/" rel="next" title="ã€ç¬”è®°ã€‘JSçš„Promiseæ‰¿è¯º">
                  ã€ç¬”è®°ã€‘JSçš„Promiseæ‰¿è¯º <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments"><div id="twikoo-comments"></div></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2019 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">57uv6Z6g</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>
<div id="site-time"></div>


<div id="current-visitors-count"></div>


<div id="site-badge"></div>


<div id="loading-door-left"></div>
<div id="loading-door-right"></div>
<a id="loading-door-a" href="javascript:loadingDoorOpen();">èŠéº»å¼€é—¨</a>


<div id="waifu">
  <div id="waifu-tips"></div>
  <canvas id="live2d" width="800" height="800"></canvas>
</div>
<div id="waifu-toggle">
  <span>çœ‹æ¿å¨˜</span>
</div>


<link rel="stylesheet" href="/dist/bundle.css">


<script src="/dist/bundle.js"></script>


    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="twikoo" type="application/json">{"enable":true,"visitor":false,"envId":"https://twikoo.loli.fj.cn","jsUrl":"https://unpkg.com/twikoo@1.6.44/dist/twikoo.min.js","el":"#twikoo-comments"}</script>
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.twikoo.el)
    .then(() => NexT.utils.getScript(
      CONFIG.twikoo.jsUrl || 'https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js',
      { condition: window.twikoo }
    ))
    .then(() => {
      twikoo.init(CONFIG.twikoo);
    });
});
</script>
<style>
.post-block, .comments {
  overflow: visible;
}
.tk-owo-emotion {
  display: inline-block;
}
</style>

</body>
</html>
